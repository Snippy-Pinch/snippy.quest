<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>How It Works | Snippy Private</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg: #0a0a1a;
            --surface: #111127;
            --surface2: #1a1a35;
            --border: #2a2a4a;
            --primary: #00d4aa;
            --accent: #ff6b6b;
            --warn: #f59e0b;
            --blue: #60a5fa;
            --purple: #a78bfa;
            --pink: #f472b6;
            --text: #e4e4e7;
            --muted: #7a8a9a;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.7;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px 80px;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: var(--muted);
            text-decoration: none;
            font-size: 0.9rem;
            margin-bottom: 2rem;
            transition: color 0.2s;
        }
        .back-link:hover { color: var(--primary); }

        h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            color: var(--muted);
            font-size: 1.05rem;
            margin-bottom: 3rem;
        }

        h2 {
            font-size: 1.4rem;
            font-weight: 700;
            margin: 3rem 0 1rem;
            color: var(--primary);
        }

        h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 2rem 0 0.75rem;
        }

        p { margin-bottom: 1rem; color: var(--text); }

        /* Flow Diagram */
        .flow {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            margin: 2rem 0;
            overflow-x: auto;
        }

        .flow-title {
            font-size: 0.85rem;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 1.5rem;
        }

        .flow-steps {
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .flow-step {
            display: flex;
            align-items: flex-start;
            gap: 16px;
        }

        .flow-line {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-shrink: 0;
            width: 40px;
        }

        .flow-dot {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.85rem;
            flex-shrink: 0;
        }

        .flow-connector {
            width: 3px;
            height: 40px;
            background: var(--border);
        }

        .flow-connector.success { background: var(--primary); }
        .flow-connector.fail { background: var(--accent); }

        .dot-blue { background: rgba(96, 165, 250, 0.2); color: var(--blue); border: 2px solid var(--blue); }
        .dot-purple { background: rgba(167, 139, 250, 0.2); color: var(--purple); border: 2px solid var(--purple); }
        .dot-green { background: rgba(0, 212, 170, 0.2); color: var(--primary); border: 2px solid var(--primary); }
        .dot-yellow { background: rgba(245, 158, 11, 0.2); color: var(--warn); border: 2px solid var(--warn); }
        .dot-pink { background: rgba(244, 114, 182, 0.2); color: var(--pink); border: 2px solid var(--pink); }
        .dot-red { background: rgba(255, 107, 107, 0.2); color: var(--accent); border: 2px solid var(--accent); }

        .flow-content {
            padding: 8px 0 24px;
            flex: 1;
        }

        .flow-label {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 4px;
        }

        .flow-desc {
            font-size: 0.87rem;
            color: var(--muted);
        }

        /* Architecture Diagram */
        .arch-diagram {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            margin: 2rem 0;
        }

        .arch-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin: 8px 0;
            flex-wrap: wrap;
        }

        .arch-box {
            padding: 12px 18px;
            border-radius: 10px;
            font-size: 0.85rem;
            font-weight: 600;
            text-align: center;
            min-width: 120px;
        }

        .arch-box.phone { background: rgba(96, 165, 250, 0.15); border: 2px solid var(--blue); color: var(--blue); }
        .arch-box.cloudflare { background: rgba(245, 158, 11, 0.15); border: 2px solid var(--warn); color: var(--warn); }
        .arch-box.worker { background: rgba(167, 139, 250, 0.15); border: 2px solid var(--purple); color: var(--purple); }
        .arch-box.tunnel { background: rgba(244, 114, 182, 0.15); border: 2px solid var(--pink); color: var(--pink); }
        .arch-box.server { background: rgba(0, 212, 170, 0.15); border: 2px solid var(--primary); color: var(--primary); }
        .arch-box.db { background: rgba(0, 212, 170, 0.25); border: 2px solid var(--primary); color: var(--primary); }
        .arch-box.github { background: rgba(255, 255, 255, 0.08); border: 2px solid #666; color: #999; }
        .arch-box.blocked { background: rgba(255, 107, 107, 0.15); border: 2px dashed var(--accent); color: var(--accent); }

        .arch-arrow {
            font-size: 1.2rem;
            color: var(--muted);
        }

        .arch-label {
            text-align: center;
            font-size: 0.75rem;
            color: var(--muted);
            margin: 2px 0 12px;
        }

        .arch-divider {
            border: none;
            border-top: 1px dashed var(--border);
            margin: 20px 0;
        }

        .arch-section-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--muted);
            margin-bottom: 12px;
        }

        /* Security Table */
        .sec-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            font-size: 0.9rem;
        }

        .sec-table th {
            text-align: left;
            padding: 10px 12px;
            background: var(--surface2);
            color: var(--muted);
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .sec-table td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
        }

        .sec-table tr:last-child td { border-bottom: none; }

        .badge-pass {
            display: inline-block;
            padding: 2px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            background: rgba(0, 212, 170, 0.15);
            color: var(--primary);
        }

        .badge-fail {
            display: inline-block;
            padding: 2px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            background: rgba(255, 107, 107, 0.15);
            color: var(--accent);
        }

        /* Component Cards */
        .components {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 12px;
            margin: 1.5rem 0;
        }

        .comp-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
        }

        .comp-card h4 {
            font-size: 0.95rem;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .comp-card p {
            font-size: 0.83rem;
            color: var(--muted);
            margin: 0;
        }

        .comp-card .comp-detail {
            font-size: 0.78rem;
            color: var(--border);
            font-family: 'SF Mono', Monaco, monospace;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border);
        }

        /* Key insight boxes */
        .insight {
            background: var(--surface2);
            border-left: 3px solid var(--primary);
            border-radius: 0 10px 10px 0;
            padding: 14px 18px;
            margin: 1.5rem 0;
        }

        .insight.warn { border-left-color: var(--warn); }

        .insight strong { color: var(--text); }
        .insight p { color: var(--muted); font-size: 0.9rem; margin: 0; }

        /* Secret locations */
        .secret-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            margin: 1rem 0;
        }

        .secret-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 14px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.88rem;
        }

        .secret-row .icon { font-size: 1.1rem; flex-shrink: 0; }

        code {
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            background: rgba(0, 212, 170, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.85em;
            color: var(--primary);
        }

        .footer-info {
            text-align: center;
            margin-top: 4rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border);
            color: var(--muted);
            font-size: 0.8rem;
        }

        @media (max-width: 640px) {
            .container { padding: 30px 16px 60px; }
            h1 { font-size: 1.6rem; }
            .arch-row { flex-direction: column; }
            .arch-arrow { transform: rotate(90deg); }
            .components { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/private/" class="back-link">‚Üê Private Dashboard</a>

        <h1>üèóÔ∏è How the Live Dashboard Works</h1>
        <p class="subtitle">The full architecture behind <code>/private/today</code> ‚Äî from your browser to the database and back.</p>

        <!-- Overview -->
        <h2>üó∫Ô∏è The Big Picture</h2>
        <p>When you open the Today page, your browser makes a request that passes through <strong>5 systems</strong> before returning your task data. Each layer adds security or functionality.</p>

        <div class="arch-diagram">
            <div class="arch-section-label">üì± Your Device</div>
            <div class="arch-row">
                <div class="arch-box phone">üì± Your Browser</div>
            </div>
            <div class="arch-label">‚Üì HTTPS request with auth cookie</div>

            <hr class="arch-divider">
            <div class="arch-section-label">‚òÅÔ∏è Cloudflare Edge (Global CDN)</div>
            <div class="arch-row">
                <div class="arch-box cloudflare">üîí CF Access<br><small>JWT Verification</small></div>
                <div class="arch-arrow">‚Üí</div>
                <div class="arch-box github">üìÑ GitHub Pages<br><small>Static HTML/JS</small></div>
            </div>
            <div class="arch-label">Page loads ‚Üë ¬∑ JS fetches /api/tasks ‚Üì</div>
            <div class="arch-row">
                <div class="arch-box worker">‚ö° CF Worker<br><small>JWT Validation + API Key Injection</small></div>
            </div>
            <div class="arch-label">‚Üì Adds secret API key (encrypted in Worker)</div>

            <hr class="arch-divider">
            <div class="arch-section-label">üîê Cloudflare Tunnel (Encrypted)</div>
            <div class="arch-row">
                <div class="arch-box tunnel">üöá CF Tunnel<br><small>api.snippy.quest</small></div>
            </div>
            <div class="arch-label">‚Üì Encrypted connection to server</div>

            <hr class="arch-divider">
            <div class="arch-section-label">üñ•Ô∏è Snippy's Server (LXC Container)</div>
            <div class="arch-row">
                <div class="arch-box server">üêç API Server<br><small>Port 8787</small></div>
                <div class="arch-arrow">‚Üí</div>
                <div class="arch-box db">üêò PostgreSQL<br><small>Task Data</small></div>
            </div>
            <div class="arch-label">‚Üë JSON response flows back through the same chain</div>
        </div>

        <!-- Step by Step Flow -->
        <h2>üîÑ Step-by-Step: What Happens When You Load the Page</h2>

        <div class="flow">
            <div class="flow-title">Authentication + Data Flow</div>
            <div class="flow-steps">

                <div class="flow-step">
                    <div class="flow-line">
                        <div class="flow-dot dot-blue">1</div>
                        <div class="flow-connector success"></div>
                    </div>
                    <div class="flow-content">
                        <div class="flow-label">You visit snippy.quest/private/today</div>
                        <div class="flow-desc">Your browser sends the request. Cloudflare Access checks: "Is this person authenticated?" If you haven't logged in recently, you get an email PIN page. Only your two email addresses are allowed. Once verified, Cloudflare sets a <strong>CF_Authorization cookie</strong> ‚Äî a signed JWT token.</div>
                    </div>
                </div>

                <div class="flow-step">
                    <div class="flow-line">
                        <div class="flow-dot dot-purple">2</div>
                        <div class="flow-connector success"></div>
                    </div>
                    <div class="flow-content">
                        <div class="flow-label">The page HTML/JS loads from GitHub Pages</div>
                        <div class="flow-desc">The static page is served from a public GitHub repo. It contains the layout, styling, and JavaScript ‚Äî but <strong>zero secrets</strong>. The JavaScript makes a fetch request to <code>/api/tasks</code>.</div>
                    </div>
                </div>

                <div class="flow-step">
                    <div class="flow-line">
                        <div class="flow-dot dot-yellow">3</div>
                        <div class="flow-connector success"></div>
                    </div>
                    <div class="flow-content">
                        <div class="flow-label">Browser fetches /api/tasks (same domain = cookie sent automatically)</div>
                        <div class="flow-desc">Because <code>/api</code> is on the same domain as <code>/private</code>, your browser automatically includes the CF_Authorization cookie. No extra login needed.</div>
                    </div>
                </div>

                <div class="flow-step">
                    <div class="flow-line">
                        <div class="flow-dot dot-purple">4</div>
                        <div class="flow-connector success"></div>
                    </div>
                    <div class="flow-content">
                        <div class="flow-label">Cloudflare Worker intercepts and validates your JWT</div>
                        <div class="flow-desc">The Worker extracts your cookie and performs <strong>cryptographic verification</strong>:
                            <br>‚úÖ <strong>Signature</strong> ‚Äî Verifies Cloudflare actually signed this token (RSA-256)
                            <br>‚úÖ <strong>Audience</strong> ‚Äî Confirms it's for this specific app, not someone else's
                            <br>‚úÖ <strong>Expiration</strong> ‚Äî Checks the token hasn't expired
                            <br>If any check fails ‚Üí 403 Unauthorized. Request dies here.
                        </div>
                    </div>
                </div>

                <div class="flow-step">
                    <div class="flow-line">
                        <div class="flow-dot dot-pink">5</div>
                        <div class="flow-connector success"></div>
                    </div>
                    <div class="flow-content">
                        <div class="flow-label">Worker adds the secret API key and forwards to backend</div>
                        <div class="flow-desc">The API key is stored as an <strong>encrypted Worker secret</strong> ‚Äî never in the browser, never in source code. The Worker injects it into the request header and forwards through the Cloudflare Tunnel.</div>
                    </div>
                </div>

                <div class="flow-step">
                    <div class="flow-line">
                        <div class="flow-dot dot-green">6</div>
                    </div>
                    <div class="flow-content">
                        <div class="flow-label">API server queries PostgreSQL and returns your tasks</div>
                        <div class="flow-desc">The Python API server on Snippy's LXC verifies the API key, queries the PostgreSQL database for your tasks, categorizes them (overdue, today, upcoming, priority), and returns JSON. The response flows back through the tunnel ‚Üí Worker ‚Üí your browser ‚Üí rendered on screen.</div>
                    </div>
                </div>

            </div>
        </div>

        <!-- What Keeps It Secure -->
        <h2>üõ°Ô∏è What Keeps It Secure</h2>

        <p>Three independent layers of security. An attacker would need to break <strong>all three</strong> to access your data.</p>

        <div class="flow">
            <div class="flow-title">Security Layers</div>
            <div class="flow-steps">
                <div class="flow-step">
                    <div class="flow-line">
                        <div class="flow-dot dot-yellow">1</div>
                        <div class="flow-connector"></div>
                    </div>
                    <div class="flow-content">
                        <div class="flow-label">Cloudflare Access (Gate to /private)</div>
                        <div class="flow-desc">Email-based authentication. Only <code>linux.trevor@gmail.com</code> and <code>trevor@bainter.xyz</code> can get in. Requires access to the actual email inbox to receive the PIN code. Sessions last 30 days.</div>
                    </div>
                </div>

                <div class="flow-step">
                    <div class="flow-line">
                        <div class="flow-dot dot-purple">2</div>
                        <div class="flow-connector"></div>
                    </div>
                    <div class="flow-content">
                        <div class="flow-label">JWT Cryptographic Verification (Worker)</div>
                        <div class="flow-desc">The Worker doesn't just check if a cookie exists ‚Äî it mathematically verifies the JWT signature using Cloudflare's public RSA keys. A forged or tampered cookie fails instantly. This is the same technology used by banks and government systems.</div>
                    </div>
                </div>

                <div class="flow-step">
                    <div class="flow-line">
                        <div class="flow-dot dot-green">3</div>
                    </div>
                    <div class="flow-content">
                        <div class="flow-label">API Key on Backend</div>
                        <div class="flow-desc">Even if someone bypasses everything above, the backend API server requires a secret key in every request. This key only exists in two places: encrypted in the Cloudflare Worker and in the server's secrets file. Never in your browser, never in source code.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Attack scenarios -->
        <h2>üß™ Attack Scenarios</h2>
        <p>What happens when someone tries to break in:</p>

        <table class="sec-table">
            <thead>
                <tr>
                    <th>Attack</th>
                    <th>What Happens</th>
                    <th>Result</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Visit snippy.quest/api/tasks directly</td>
                    <td>No CF_Authorization cookie ‚Üí Worker rejects</td>
                    <td><span class="badge-fail">‚ùå Blocked</span></td>
                </tr>
                <tr>
                    <td>Send a fake cookie</td>
                    <td>JWT signature check fails (can't forge Cloudflare's RSA signature)</td>
                    <td><span class="badge-fail">‚ùå Blocked</span></td>
                </tr>
                <tr>
                    <td>Use an expired cookie</td>
                    <td>JWT expiration check fails</td>
                    <td><span class="badge-fail">‚ùå Blocked</span></td>
                </tr>
                <tr>
                    <td>Steal a cookie from a different CF Access app</td>
                    <td>Audience (aud) check fails ‚Äî wrong app ID</td>
                    <td><span class="badge-fail">‚ùå Blocked</span></td>
                </tr>
                <tr>
                    <td>Hit api.snippy.quest directly</td>
                    <td>No API key in header ‚Üí backend rejects</td>
                    <td><span class="badge-fail">‚ùå Blocked</span></td>
                </tr>
                <tr>
                    <td>Read the GitHub repo source code</td>
                    <td>No secrets in the repo ‚Äî API key is in Worker secret, not source</td>
                    <td><span class="badge-fail">‚ùå Nothing to find</span></td>
                </tr>
                <tr>
                    <td>Authenticated user with valid session</td>
                    <td>CF Access ‚úÖ ‚Üí JWT valid ‚úÖ ‚Üí Worker adds key ‚úÖ ‚Üí Data returned</td>
                    <td><span class="badge-pass">‚úÖ Allowed</span></td>
                </tr>
            </tbody>
        </table>

        <!-- Components -->
        <h2>üß© System Components</h2>

        <div class="components">
            <div class="comp-card">
                <h4>üìÑ GitHub Pages</h4>
                <p>Hosts the static HTML, CSS, and JavaScript. Public repo, but contains zero secrets.</p>
                <div class="comp-detail">snippy-pinch.github.io ‚Üí snippy.quest</div>
            </div>
            <div class="comp-card">
                <h4>üîí Cloudflare Access</h4>
                <p>Email PIN authentication. Controls who can view /private/ pages. Sets the JWT cookie.</p>
                <div class="comp-detail">30-day sessions ¬∑ 2 allowed emails</div>
            </div>
            <div class="comp-card">
                <h4>‚ö° Cloudflare Worker</h4>
                <p>Intercepts /api/* requests. Validates JWT, injects API key, proxies to backend.</p>
                <div class="comp-detail">snippy-api-proxy ¬∑ RS256 JWT verification</div>
            </div>
            <div class="comp-card">
                <h4>üöá Cloudflare Tunnel</h4>
                <p>Encrypted connection from Cloudflare's edge to Snippy's server. No open ports.</p>
                <div class="comp-detail">api.snippy.quest ‚Üí 127.0.0.1:8787</div>
            </div>
            <div class="comp-card">
                <h4>üêç Todo API Server</h4>
                <p>Python HTTP server on port 8787. Validates API key, queries database, returns JSON.</p>
                <div class="comp-detail">systemd: snippy-todo-api</div>
            </div>
            <div class="comp-card">
                <h4>üêò PostgreSQL</h4>
                <p>Database with all task data. Synced from Microsoft To Do every 30 minutes via heartbeat.</p>
                <div class="comp-detail">10.16.50.71 ¬∑ clawdbot DB</div>
            </div>
        </div>

        <!-- Where Secrets Live -->
        <h2>üîë Where Secrets Live</h2>
        <p>Every secret is stored encrypted. Nothing is in source code or visible publicly.</p>

        <div class="secret-grid">
            <div class="secret-row">
                <span class="icon">üîê</span>
                <div>
                    <strong>API Key</strong> ‚Äî Cloudflare Worker encrypted secret + server secrets file
                    <br><small style="color: var(--muted);">Never in browser, never in GitHub repo</small>
                </div>
            </div>
            <div class="secret-row">
                <span class="icon">üîê</span>
                <div>
                    <strong>Tunnel Token</strong> ‚Äî Server secrets file, loaded by systemd on boot
                    <br><small style="color: var(--muted);">/root/.clawdbot/secrets/cloudflare_tunnel.json</small>
                </div>
            </div>
            <div class="secret-row">
                <span class="icon">üîê</span>
                <div>
                    <strong>JWT Signing Keys</strong> ‚Äî Cloudflare's private RSA keys (we only have the public keys for verification)
                    <br><small style="color: var(--muted);">Managed entirely by Cloudflare, rotated automatically</small>
                </div>
            </div>
            <div class="secret-row">
                <span class="icon">üîê</span>
                <div>
                    <strong>Database Credentials</strong> ‚Äî Server secrets file, read by API server
                    <br><small style="color: var(--muted);">/root/.clawdbot/secrets/postgres.json</small>
                </div>
            </div>
        </div>

        <!-- Data Freshness -->
        <h2>üîÑ How Task Data Stays Fresh</h2>

        <div class="flow">
            <div class="flow-title">Data Sync Pipeline</div>
            <div class="flow-steps">
                <div class="flow-step">
                    <div class="flow-line">
                        <div class="flow-dot dot-blue">1</div>
                        <div class="flow-connector success"></div>
                    </div>
                    <div class="flow-content">
                        <div class="flow-label">Microsoft To Do (Source of Truth)</div>
                        <div class="flow-desc">You add, complete, or modify tasks in the MS To Do app. 16 lists, ~150 tasks.</div>
                    </div>
                </div>
                <div class="flow-step">
                    <div class="flow-line">
                        <div class="flow-dot dot-yellow">2</div>
                        <div class="flow-connector success"></div>
                    </div>
                    <div class="flow-content">
                        <div class="flow-label">Heartbeat Sync (Every 30 Minutes)</div>
                        <div class="flow-desc">Snippy's heartbeat runs <code>sync_todos_full.py</code> which pulls all tasks from MS Graph API and syncs them into PostgreSQL. Creates, updates, and marks completed tasks.</div>
                    </div>
                </div>
                <div class="flow-step">
                    <div class="flow-line">
                        <div class="flow-dot dot-green">3</div>
                    </div>
                    <div class="flow-content">
                        <div class="flow-label">Dashboard Auto-Refreshes (Every 60 Seconds)</div>
                        <div class="flow-desc">The page JavaScript re-fetches from the API every 60 seconds. You always see near-real-time data without refreshing the page.</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="insight">
            <p><strong>Why the database instead of MS Graph API directly?</strong> Speed and reliability. The database responds in milliseconds. MS Graph API can be slow or rate-limited. The database also gives us analytics, history tracking, and search capabilities that Microsoft doesn't offer.</p>
        </div>

        <div class="footer-info">
            Built by Snippy ü¶Ä ¬∑ Architecture documented February 19, 2026
        </div>
    </div>
</body>
</html>

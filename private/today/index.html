<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Today's Tasks | Live</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg: #0a0a1a;
            --surface: #111127;
            --surface2: #1a1a35;
            --border: #2a2a4a;
            --primary: #00d4aa;
            --accent: #ff6b6b;
            --warn: #f59e0b;
            --purple: #a78bfa;
            --text: #e4e4e7;
            --muted: #7a8a9a;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
            padding: 40px 20px 80px;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: var(--muted);
            text-decoration: none;
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
            transition: color 0.2s;
        }

        .back-link:hover { color: var(--primary); }

        .header {
            text-align: center;
            margin-bottom: 2.5rem;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .header .date {
            color: var(--muted);
            font-size: 1.1rem;
        }

        .header .summary {
            margin-top: 0.75rem;
            font-size: 0.95rem;
            color: var(--primary);
        }

        .live-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            color: var(--primary);
            background: rgba(0, 212, 170, 0.1);
            padding: 4px 10px;
            border-radius: 20px;
            margin-top: 0.75rem;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: var(--primary);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .section {
            margin-bottom: 2rem;
        }

        .section h2 {
            font-size: 1.15rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        .overdue h2 { color: var(--accent); border-bottom-color: rgba(255, 107, 107, 0.3); }
        .today-tasks h2 { color: var(--primary); border-bottom-color: rgba(0, 212, 170, 0.3); }
        .upcoming h2 { color: var(--warn); border-bottom-color: rgba(245, 158, 11, 0.3); }
        .priority h2 { color: var(--purple); border-bottom-color: rgba(167, 139, 250, 0.3); }
        .backlog h2 { color: var(--muted); border-bottom-color: rgba(122, 138, 154, 0.3); }

        .task-card {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 14px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            margin-bottom: 8px;
            transition: border-color 0.2s;
        }

        .task-card:hover { border-color: var(--primary); }

        .task-check {
            width: 22px;
            height: 22px;
            border: 2px solid var(--muted);
            border-radius: 6px;
            flex-shrink: 0;
            margin-top: 2px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            background: transparent;
            padding: 0;
        }

        .task-check:hover {
            border-color: var(--primary);
            background: rgba(0, 212, 170, 0.1);
        }

        .task-check.completing {
            border-color: var(--primary);
            background: var(--primary);
            animation: checkPop 0.3s ease;
        }

        .task-check.completing::after {
            content: '‚úì';
            color: var(--bg);
            font-size: 14px;
            font-weight: 700;
        }

        .task-card.completed {
            opacity: 0.4;
            transform: scale(0.98);
            transition: all 0.4s ease;
        }

        .task-card.completed .task-title {
            text-decoration: line-through;
        }

        .task-card.removing {
            opacity: 0;
            max-height: 0;
            padding: 0 14px;
            margin-bottom: 0;
            overflow: hidden;
            transition: all 0.5s ease 0.3s;
        }

        .task-check.error {
            border-color: var(--accent);
            animation: shake 0.3s ease;
        }

        @keyframes checkPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-4px); }
            75% { transform: translateX(4px); }
        }

        .task-content { flex: 1; min-width: 0; }

        .task-title {
            font-weight: 500;
            font-size: 0.95rem;
            margin-bottom: 4px;
        }

        .task-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .badge {
            font-size: 0.72rem;
            padding: 2px 8px;
            border-radius: 6px;
            white-space: nowrap;
        }

        .badge-important { background: rgba(255, 107, 107, 0.15); color: var(--accent); }
        .badge-list { background: rgba(0, 212, 170, 0.1); color: var(--primary); }
        .badge-date { background: rgba(245, 158, 11, 0.1); color: var(--warn); }

        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--muted);
            font-size: 1.1rem;
        }

        .loading {
            text-align: center;
            padding: 4rem 0;
            color: var(--muted);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .error-state {
            text-align: center;
            padding: 2rem;
            color: var(--accent);
            background: rgba(255, 107, 107, 0.05);
            border: 1px solid rgba(255, 107, 107, 0.2);
            border-radius: 10px;
        }

        .footer-info {
            text-align: center;
            margin-top: 3rem;
            color: var(--muted);
            font-size: 0.8rem;
        }

        .sync-fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            border: none;
            background: var(--primary);
            color: var(--bg);
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(0, 212, 170, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 100;
        }

        .sync-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 212, 170, 0.4);
        }

        .sync-fab:active { transform: scale(0.95); }

        .sync-fab.syncing {
            pointer-events: none;
            background: var(--surface2);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        }

        .sync-fab.syncing .sync-icon {
            animation: spin 0.8s linear infinite;
        }

        @media (max-width: 640px) {
            .container { padding: 30px 16px 60px; }
            .header h1 { font-size: 1.6rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/private/" class="back-link">‚Üê Private Dashboard</a>

        <div class="header">
            <h1 id="pageTitle">üìã Loading...</h1>
            <div class="date" id="pageDate"></div>
            <div class="summary" id="pageSummary"></div>
            <div class="live-badge" id="liveBadge"><div class="live-dot"></div> <span id="liveStatus">Loading from cache...</span></div>
        </div>

        <div id="content">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>Fetching tasks...</p>
            </div>
        </div>

        <div class="footer-info" id="footerInfo"></div>
    </div>

    <button class="sync-fab" id="syncFab" onclick="manualSync()" title="Sync with MS To Do">
        <span class="sync-icon">üîÑ</span>
    </button>

    <script>
        const API = '/api/tasks';

        function renderTask(task, showDate = false) {
            const imp = task.important ? '<span class="badge badge-important">‚ùó Important</span>' : '';
            const list = task.list ? `<span class="badge badge-list">${esc(task.list)}</span>` : '';
            const date = showDate && task.due ? `<span class="badge badge-date">${formatDate(task.due)}</span>` : '';
            const taskId = task.id ? `data-task-id="${esc(task.id)}"` : '';

            return `<div class="task-card" ${taskId}>
                <button class="task-check" onclick="completeTask(this)" title="Mark complete"></button>
                <div class="task-content">
                    <div class="task-title">${esc(task.title)}</div>
                    <div class="task-meta">${imp}${list}${date}</div>
                </div>
            </div>`;
        }

        function renderSection(cls, emoji, label, tasks, showDate = false) {
            if (!tasks || tasks.length === 0) return '';
            const items = tasks.map(t => renderTask(t, showDate)).join('');
            return `<div class="section ${cls}">
                <h2>${emoji} ${label} (${tasks.length})</h2>
                ${items}
            </div>`;
        }

        function esc(s) {
            const d = document.createElement('div');
            d.textContent = s;
            return d.innerHTML;
        }

        function formatDate(iso) {
            if (!iso) return '';
            const d = new Date(iso + 'T00:00:00');
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function showToast(msg, isError) {
            const t = document.createElement('div');
            t.style.cssText = `position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
                padding:10px 20px;border-radius:8px;font-size:0.9rem;z-index:999;
                background:${isError ? 'rgba(255,107,107,0.95)' : 'rgba(0,212,170,0.95)'};
                color:${isError ? '#fff' : '#0a0a1a'};font-weight:500;
                box-shadow:0 4px 12px rgba(0,0,0,0.3);transition:opacity 0.3s;`;
            t.textContent = msg;
            document.body.appendChild(t);
            setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 300); }, 3000);
        }

        async function completeTask(btn) {
            const card = btn.closest('.task-card');
            const taskId = card?.dataset?.taskId;

            if (!taskId) {
                showToast('No task ID ‚Äî cannot complete', true);
                btn.classList.add('error');
                setTimeout(() => btn.classList.remove('error'), 600);
                return;
            }

            // Prevent double-click
            if (btn.classList.contains('completing')) return;

            // Optimistic UI
            btn.classList.add('completing');
            card.classList.add('completed');

            try {
                const r = await fetch(`/api/tasks/complete?id=${encodeURIComponent(taskId)}`, {
                    method: 'POST'
                });

                let data;
                const text = await r.text();
                try { data = JSON.parse(text); } catch { data = { error: text }; }

                if (!r.ok || data.error) {
                    btn.classList.remove('completing');
                    card.classList.remove('completed');
                    btn.classList.add('error');
                    setTimeout(() => btn.classList.remove('error'), 600);
                    showToast(`Failed: ${data.error || r.status}`, true);
                    return;
                }

                showToast(`‚úì ${data.title || 'Task'} completed`, false);

                // Animate removal
                setTimeout(() => {
                    card.classList.add('removing');
                    const summary = document.getElementById('pageSummary');
                    if (summary) {
                        const m = summary.textContent.match(/(\d+) item/);
                        if (m) {
                            const n = Math.max(0, parseInt(m[1]) - 1);
                            summary.textContent = summary.textContent.replace(/\d+ item/, `${n} item`);
                        }
                    }
                    setTimeout(() => {
                        const section = card.closest('.section');
                        card.remove();
                        if (section && section.querySelectorAll('.task-card').length === 0) {
                            section.remove();
                        }
                    }, 800);
                }, 500);

            } catch (e) {
                btn.classList.remove('completing');
                card.classList.remove('completed');
                btn.classList.add('error');
                setTimeout(() => btn.classList.remove('error'), 600);
                showToast(`Network error: ${e.message}`, true);
            }
        }

        function renderData(data) {
            document.getElementById('pageTitle').textContent = `üìã ${data.day}`;
            document.getElementById('pageDate').textContent = new Date(data.date + 'T00:00:00')
                .toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

            const actionable = (data.overdue?.length || 0) + (data.today?.length || 0);
            document.getElementById('pageSummary').textContent =
                `${actionable} item${actionable !== 1 ? 's' : ''} need${actionable === 1 ? 's' : ''} attention ¬∑ ${data.total_open} total open`;

            let html = '';
            if (actionable === 0 && (!data.upcoming || data.upcoming.length === 0)) {
                html += '<div class="empty-state">‚ú® Nothing urgent. Check priorities below.</div>';
            }
            html += renderSection('overdue', 'üî¥', 'Overdue', data.overdue, true);
            html += renderSection('today-tasks', 'üìå', 'Due Today', data.today);
            html += renderSection('upcoming', 'üìÖ', 'Coming This Week', data.upcoming, true);
            html += renderSection('priority', '‚≠ê', 'High Priority', data.priority);
            html += renderSection('backlog', 'üì¶', 'Backlog', data.backlog);
            document.getElementById('content').innerHTML = html;

            const gen = new Date(data.generated);
            document.getElementById('footerInfo').textContent =
                `Data from ${gen.toLocaleTimeString()} ¬∑ Syncs with MS To Do on load`;
        }

        async function fetchJSON(url) {
            const r = await fetch(url);
            if (!r.ok) throw new Error(`HTTP ${r.status}`);
            const data = await r.json();
            if (data.error) throw new Error(data.error);
            return data;
        }

        async function init() {
            const status = document.getElementById('liveStatus');

            try {
                // Phase 1: instant load from DB cache
                status.textContent = 'Loading cached...';
                const cached = await fetchJSON('/api/tasks');
                renderData(cached);
                status.textContent = 'Syncing with MS To Do...';

                // Phase 2: background sync from MS Graph
                try {
                    const fresh = await fetchJSON('/api/tasks/refresh');
                    renderData(fresh);
                    status.textContent = 'Live ¬∑ synced just now';
                } catch (e) {
                    // Sync failed but cached data is showing ‚Äî not critical
                    status.textContent = 'Live ¬∑ sync failed, showing cached';
                    console.warn('Refresh failed:', e);
                }

            } catch (e) {
                document.getElementById('content').innerHTML =
                    `<div class="error-state">‚ö†Ô∏è Failed to load: ${esc(e.message)}<br><small>Retrying in 15s...</small></div>`;
                status.textContent = 'Offline';
                setTimeout(init, 15000);
                return;
            }

        }

        async function manualSync() {
            const fab = document.getElementById('syncFab');
            const status = document.getElementById('liveStatus');
            if (fab.classList.contains('syncing')) return;

            fab.classList.add('syncing');
            status.textContent = 'Syncing with MS To Do...';

            try {
                const data = await fetchJSON('/api/tasks/refresh');
                renderData(data);
                status.textContent = 'Live ¬∑ synced just now';
                showToast('Synced ‚úì', false);
            } catch (e) {
                status.textContent = 'Sync failed';
                showToast(`Sync failed: ${e.message}`, true);
            } finally {
                fab.classList.remove('syncing');
            }
        }

        init();
    </script>
</body>
</html>

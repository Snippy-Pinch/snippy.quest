<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Today ‚Äî Schedule + Tasks | Snippy</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg: #0a0a1a; --surface: #111127; --surface2: #1a1a35;
            --border: #2a2a4a; --primary: #00d4aa; --accent: #ff6b6b;
            --warn: #f59e0b; --purple: #a78bfa; --blue: #60a5fa;
            --text: #e4e4e7; --muted: #7a8a9a;
            --work: #3b82f6; --personal: #8b5cf6; --free: #10b981;
            --lunch: #f59e0b;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg); color: var(--text);
            min-height: 100vh; line-height: 1.6;
        }
        .container { max-width: 760px; margin: 0 auto; padding: 24px 16px 120px; }

        .back-link {
            display: inline-flex; align-items: center; gap: 6px;
            color: var(--muted); text-decoration: none; font-size: 0.85rem;
            margin-bottom: 1rem; transition: color 0.2s;
        }
        .back-link:hover { color: var(--primary); }

        /* Header */
        .header { margin-bottom: 1rem; }
        .header h1 { font-size: 1.6rem; font-weight: 700; margin-bottom: 2px; }
        .header .date-str { color: var(--muted); font-size: 0.95rem; }
        .work-badge {
            display: inline-block; font-size: 0.75rem;
            padding: 2px 10px; border-radius: 20px;
            background: rgba(59,130,246,0.12); color: var(--work);
            border: 1px solid rgba(59,130,246,0.25);
        }
        .off-badge {
            background: rgba(16,185,129,0.12); color: var(--free);
            border: 1px solid rgba(16,185,129,0.25);
        }

        /* Tab bar */
        .tab-bar {
            display: flex; gap: 2px; margin-bottom: 1rem;
            background: var(--surface); border-radius: 10px; padding: 3px;
            border: 1px solid var(--border);
        }
        .tab-btn {
            flex: 1; padding: 8px 12px; border: none; border-radius: 8px;
            background: transparent; color: var(--muted); font-size: 0.82rem;
            font-weight: 600; cursor: pointer; transition: all 0.2s;
        }
        .tab-btn.active { background: var(--surface2); color: var(--primary); }
        .tab-btn:hover:not(.active) { color: var(--text); }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        /* =========== SCHEDULE PANEL =========== */
        .all-day-bar {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 10px; padding: 8px 12px; margin-bottom: 0.75rem;
            display: flex; gap: 6px; align-items: center; flex-wrap: wrap;
        }
        .all-day-tag {
            font-size: 0.75rem; padding: 2px 8px; border-radius: 6px;
            background: rgba(167,139,250,0.1); color: var(--purple);
            border: 1px solid rgba(167,139,250,0.2);
        }
        .all-day-label { font-size: 0.7rem; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; }

        .up-next {
            background: linear-gradient(135deg, rgba(0,212,170,0.08), rgba(139,92,246,0.08));
            border: 1px solid rgba(0,212,170,0.2);
            border-radius: 12px; padding: 12px 14px; margin-bottom: 0.75rem;
        }
        .up-next-label { font-size: 0.68rem; text-transform: uppercase; letter-spacing: 1px; color: var(--primary); margin-bottom: 4px; }
        .up-next-title { font-weight: 700; font-size: 1rem; }
        .up-next-time { font-size: 0.82rem; color: var(--muted); }
        .up-next-countdown { font-size: 0.82rem; color: var(--warn); margin-top: 2px; }

        .free-chips { margin-bottom: 0.75rem; }
        .free-chip {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 4px 10px; border-radius: 20px; margin: 2px 4px 2px 0;
            font-size: 0.78rem; background: rgba(16,185,129,0.08);
            border: 1px solid rgba(16,185,129,0.2); color: var(--free);
        }

        .timeline { position: relative; padding-left: 56px; }
        .time-slot { position: relative; margin-bottom: 2px; }
        .time-label {
            position: absolute; left: -54px; top: 0; width: 46px;
            font-size: 0.7rem; color: var(--muted); text-align: right;
            font-variant-numeric: tabular-nums; padding-top: 2px;
        }
        .event-block {
            border-radius: 8px; padding: 7px 11px; margin-bottom: 2px;
            font-size: 0.82rem; border-left: 3px solid; transition: all 0.2s;
        }
        .event-block.work { background: rgba(59,130,246,0.08); border-left-color: var(--work); }
        .event-block.work-free { background: rgba(59,130,246,0.04); border-left-color: var(--work); opacity: 0.6; border-left-style: dashed; }
        .event-block.personal { background: rgba(139,92,246,0.1); border-left-color: var(--personal); }
        .event-block.lunch { background: rgba(245,158,11,0.08); border-left-color: var(--lunch); }
        .event-title { font-weight: 600; font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .event-time { font-size: 0.7rem; color: var(--muted); }
        .event-meta { font-size: 0.68rem; color: var(--muted); }

        .now-line {
            position: relative; height: 2px; background: var(--accent);
            margin: 8px 0; z-index: 10;
        }
        .now-line::before {
            content: 'NOW'; position: absolute; left: -50px; top: -7px;
            font-size: 0.62rem; font-weight: 700; color: var(--accent); letter-spacing: 1px;
        }
        .now-line .now-dot {
            position: absolute; left: -5px; top: -4px;
            width: 10px; height: 10px; background: var(--accent); border-radius: 50%;
        }

        .date-nav {
            display: flex; gap: 8px; margin-bottom: 0.75rem;
        }
        .date-nav button {
            background: var(--surface); border: 1px solid var(--border);
            color: var(--text); border-radius: 8px; padding: 5px 12px;
            font-size: 0.78rem; cursor: pointer; transition: all 0.2s;
        }
        .date-nav button:hover { border-color: var(--primary); color: var(--primary); }
        .date-nav .today-btn { color: var(--primary); border-color: rgba(0,212,170,0.3); }

        /* =========== TASKS PANEL =========== */
        .section-label {
            font-size: 0.72rem; text-transform: uppercase; letter-spacing: 1.5px;
            color: var(--muted); margin: 1.5rem 0 0.6rem; padding-bottom: 5px;
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; gap: 8px;
        }
        .section-count { font-size: 0.68rem; background: var(--surface2); padding: 2px 7px; border-radius: 10px; }

        .stats-row { display: flex; gap: 8px; margin-bottom: 1rem; flex-wrap: wrap; }
        .stat {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 10px; padding: 8px 12px; text-align: center; flex: 1; min-width: 65px;
        }
        .stat .num { font-size: 1.1rem; font-weight: 700; }
        .stat .label { font-size: 0.62rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }

        .time-bar { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 10px 14px; margin-bottom: 1rem; }
        .time-bar-header { display: flex; justify-content: space-between; font-size: 0.78rem; color: var(--muted); margin-bottom: 5px; }
        .time-bar-track { height: 6px; background: var(--surface2); border-radius: 3px; overflow: hidden; }
        .time-bar-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }

        /* Task cards */
        .focus-card {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 12px; padding: 14px 16px; margin-bottom: 8px;
            display: flex; gap: 10px; border-left: 4px solid var(--primary);
            transition: all 0.2s;
        }
        .card-check {
            width: 22px; height: 22px; border: 2px solid var(--muted);
            border-radius: 6px; flex-shrink: 0; margin-top: 1px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.2s; background: transparent; padding: 0;
        }
        .card-check:hover { border-color: var(--primary); background: rgba(0,212,170,0.1); }
        .card-check.completing { border-color: var(--primary); background: var(--primary); animation: checkPop 0.3s ease; }
        .card-check.completing::after { content: '‚úì'; color: var(--bg); font-size: 13px; font-weight: 700; }
        .card-check.error { border-color: var(--accent); animation: shake 0.3s ease; }
        .focus-card.completed, .week-card.completed, .wait-item.completed { opacity: 0.35; }
        .focus-card.completed .card-title, .week-card.completed .card-title { text-decoration: line-through; }
        .focus-card.removing, .week-card.removing, .wait-item.removing {
            opacity: 0; max-height: 0; padding: 0; margin: 0; overflow: hidden;
            transition: all 0.5s ease 0.2s;
        }
        @keyframes checkPop { 0%{transform:scale(1)} 50%{transform:scale(1.2)} 100%{transform:scale(1)} }
        @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-4px)} 75%{transform:translateX(4px)} }

        .card-body { flex: 1; min-width: 0; }
        .card-title { font-weight: 600; font-size: 0.92rem; margin-bottom: 3px; }
        .card-action {
            font-size: 0.82rem; color: var(--primary); margin-bottom: 6px;
            padding: 6px 10px; background: rgba(0,212,170,0.06);
            border-radius: 6px; border-left: 3px solid var(--primary);
        }
        .card-action::before { content: '‚Üí '; font-weight: 700; }
        .card-why { font-size: 0.78rem; color: var(--warn); margin-bottom: 4px; }
        .card-why::before { content: '‚ö° '; }
        .card-meta { display: flex; flex-wrap: wrap; gap: 4px; align-items: center; }
        .badge { font-size: 0.7rem; padding: 2px 7px; border-radius: 6px; white-space: nowrap; }
        .badge-context { background: rgba(167,139,250,0.12); color: var(--purple); }
        .badge-time { background: rgba(96,165,250,0.12); color: var(--blue); }
        .badge-due { background: rgba(245,158,11,0.12); color: var(--warn); }
        .badge-overdue { background: rgba(255,107,107,0.15); color: var(--accent); }
        .badge-list { background: rgba(255,255,255,0.05); color: var(--muted); }
        .card-tip { font-size: 0.75rem; color: var(--muted); margin-top: 6px; font-style: italic; }
        .card-tip::before { content: 'üí° '; }

        .week-card {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 10px; padding: 10px 12px; margin-bottom: 5px;
            display: flex; gap: 10px; transition: all 0.2s;
        }
        .week-card .card-title { font-size: 0.88rem; }
        .week-card .card-action { font-size: 0.8rem; padding: 5px 9px; margin-bottom: 5px; }

        .batch-header {
            display: flex; align-items: center; gap: 10px;
            padding: 6px 0; margin: 10px 0 5px; border-bottom: 1px dashed var(--border);
        }
        .batch-name { font-size: 0.88rem; font-weight: 600; flex: 1; }
        .batch-meta { font-size: 0.7rem; color: var(--muted); }

        .wait-item {
            display: flex; align-items: center; gap: 10px;
            padding: 7px 10px; background: var(--surface);
            border: 1px solid var(--border); border-radius: 8px;
            margin-bottom: 3px; font-size: 0.83rem; transition: all 0.2s;
        }
        .wait-item .card-check { width: 18px; height: 18px; min-width: 18px; }

        .backlog-list-name { font-size: 0.76rem; font-weight: 600; color: var(--muted); margin: 8px 0 3px; }

        .collapse-toggle {
            background: none; border: none; color: var(--muted); cursor: pointer;
            font-size: 0.72rem; padding: 3px 7px; border-radius: 6px; transition: all 0.2s;
        }
        .collapse-toggle:hover { color: var(--text); background: var(--surface2); }
        .collapsed { display: none; }

        /* Status bar */
        .status-bar {
            display: flex; align-items: center; gap: 6px;
            margin-top: 0.5rem; font-size: 0.75rem; color: var(--muted);
        }
        .status-dot {
            width: 7px; height: 7px; border-radius: 50%;
            background: var(--primary); animation: pulse 2s infinite;
        }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }

        .toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            padding: 8px 18px; border-radius: 8px; font-size: 0.88rem; z-index: 999;
            font-weight: 500; box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: opacity 0.3s;
        }

        .fab-group { position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 8px; z-index: 100; }
        .fab {
            width: 44px; height: 44px; border-radius: 50%; border: none;
            color: var(--bg); font-size: 1.1rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .fab:hover { transform: scale(1.1); }
        .fab-sync { background: var(--primary); }
        .fab-refresh { background: var(--purple); }
        .fab.syncing { pointer-events: none; background: var(--surface2); }
        .fab.syncing .fab-icon { animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Skeleton shimmer */
        .skel-wrap { padding-top: 0.5rem; }
        .skel-bar {
            background: linear-gradient(90deg, var(--surface) 25%, var(--surface2) 50%, var(--surface) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }

        /* Loading */
        .loading { text-align: center; padding: 2rem 0; color: var(--muted); }
        .spinner {
            width: 28px; height: 28px; border: 3px solid var(--border);
            border-top-color: var(--primary); border-radius: 50%;
            animation: spin 0.7s linear infinite; margin: 0 auto 0.5rem;
        }

        @media (max-width: 480px) {
            .container { padding: 20px 12px 100px; }
            .header h1 { font-size: 1.4rem; }
            .timeline { padding-left: 48px; }
            .time-label { left: -46px; width: 40px; font-size: 0.66rem; }
            .stats-row { gap: 6px; }
            .stat { padding: 7px 8px; min-width: 55px; }
            .stat .num { font-size: 0.95rem; }
            .stat .label { font-size: 0.58rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/private/" class="back-link">‚Üê Dashboard</a>

        <div class="header">
            <h1 id="title">‚è≥ Loading...</h1>
            <div class="date-str" id="dateStr"></div>
            <div class="status-bar">
                <div class="status-dot"></div>
                <span id="statusText">Loading...</span>
            </div>
        </div>

        <div class="tab-bar">
            <button class="tab-btn active" onclick="switchTab('combined')">üìã Combined</button>
            <button class="tab-btn" onclick="switchTab('schedule')">üìÖ Schedule</button>
            <button class="tab-btn" onclick="switchTab('tasks')">‚úÖ Tasks</button>
        </div>

        <!-- COMBINED VIEW -->
        <div class="tab-panel active" id="panel-combined">
            <div id="combined-schedule">
                <div class="skel-wrap">
                    <div class="skel-bar" style="width:100%;height:44px;margin-bottom:6px;border-radius:10px"></div>
                    <div class="skel-bar" style="width:60%;height:28px;border-radius:20px"></div>
                </div>
            </div>
            <div id="combined-tasks">
                <div class="loading"><div class="spinner"></div><p>Loading tasks...</p></div>
            </div>
        </div>

        <!-- SCHEDULE ONLY -->
        <div class="tab-panel" id="panel-schedule">
            <div class="date-nav">
                <button onclick="navDay(-1)">‚Üê Prev</button>
                <button class="today-btn" onclick="navToday()">Today</button>
                <button onclick="navDay(1)">Next ‚Üí</button>
            </div>
            <div id="schedule-full"></div>
        </div>

        <!-- TASKS ONLY -->
        <div class="tab-panel" id="panel-tasks">
            <div id="tasks-full"></div>
        </div>
    </div>

    <div class="fab-group">
        <button class="fab fab-refresh" id="fabRefresh" onclick="fullRefresh()" title="Re-analyze with AI">
            <span class="fab-icon">üß†</span>
        </button>
        <button class="fab fab-sync" id="fabSync" onclick="syncOnly()" title="Sync MS To Do">
            <span class="fab-icon">üîÑ</span>
        </button>
    </div>

    <script>
        let scheduleData = null, taskData = null;
        let currentDate = new Date().toISOString().slice(0,10);
        let lastGenerated = '';

        function esc(s) { if(!s) return ''; const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }
        function fmtTime12(t) {
            if (!t) return '';
            const [h, m] = t.split(':').map(Number);
            const ap = h >= 12 ? 'PM' : 'AM';
            return (m===0 ? `${h%12||12} ${ap}` : `${h%12||12}:${String(m).padStart(2,'0')} ${ap}`);
        }
        function minsBetween(a, b) {
            const [ah,am]=a.split(':').map(Number), [bh,bm]=b.split(':').map(Number);
            return (bh*60+bm)-(ah*60+am);
        }
        function fmtDur(m) { return m<60?`${m}m`:(m%60?`${Math.floor(m/60)}h ${m%60}m`:`${m/60}h`); }
        function fmtTime(min) { return fmtDur(min); }

        function showToast(msg, err) {
            const t=document.createElement('div'); t.className='toast';
            t.style.background=err?'rgba(255,107,107,0.95)':'rgba(0,212,170,0.95)';
            t.style.color=err?'#fff':'#0a0a1a'; t.textContent=msg;
            document.body.appendChild(t);
            setTimeout(()=>{t.style.opacity='0';setTimeout(()=>t.remove(),300)},3000);
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach((b,i)=>{
                b.classList.toggle('active', b.textContent.includes(
                    tab==='combined'?'Combined':tab==='schedule'?'Schedule':'Tasks'));
            });
            document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
            document.getElementById('panel-'+tab).classList.add('active');
        }

        // ========= SCHEDULE RENDERING =========
        function classifyEv(e, isWork) {
            if (!isWork) return 'personal';
            if (e.subject.toLowerCase().includes('lunch')) return 'lunch';
            return e.showAs==='free' ? 'work-free' : 'work';
        }

        function renderSchedule(data, targetEl, compact) {
            const isToday = data.date === new Date().toISOString().slice(0,10);
            let html = '';

            // All-day
            if (data.all_day?.length) {
                html += '<div class="all-day-bar"><span class="all-day-label">All Day</span>';
                data.all_day.forEach(e => html += `<span class="all-day-tag">${esc(e.subject)}</span>`);
                html += '</div>';
            }

            // Merge events
            const all = [];
            (data.work_events||[]).forEach(e => all.push({...e, _type: classifyEv(e,true), _src:'work'}));
            (data.personal_events||[]).forEach(e => all.push({...e, _type:'personal', _src:'personal'}));
            all.sort((a,b) => a.start.localeCompare(b.start));

            // Up next
            if (isToday && data.current_time) {
                const now = data.current_time.replace(':','');
                const next = all.find(e => e.start.replace(':','') > now);
                if (next) {
                    const mins = minsBetween(data.current_time, next.start);
                    html += `<div class="up-next">
                        <div class="up-next-label">‚è≠ Up Next</div>
                        <div class="up-next-title">${esc(next.subject)}</div>
                        <div class="up-next-time">${fmtTime12(next.start)} ‚Äì ${fmtTime12(next.end)}</div>
                        ${mins>0?`<div class="up-next-countdown">in ${fmtDur(mins)}</div>`:''}
                    </div>`;
                }
            }

            // Free windows
            if (data.free_windows?.length) {
                html += '<div class="free-chips">';
                data.free_windows.forEach(w => {
                    const dur = minsBetween(w.start, w.end);
                    if (dur > 0) html += `<span class="free-chip">üü¢ ${fmtTime12(w.start)}‚Äì${fmtTime12(w.end)} (${fmtDur(dur)})</span>`;
                });
                html += '</div>';
            }

            // Timeline
            if (!compact) {
                html += '<div class="timeline">';
                let lastEnd = null;
                for (const ev of all) {
                    const dur = minsBetween(ev.start, ev.end);
                    const showTime = !lastEnd || ev.start !== lastEnd;

                    // Insert NOW line
                    if (isToday && data.current_time && lastEnd && ev.start.replace(':','') > data.current_time.replace(':','') && (!lastEnd || lastEnd.replace(':','') <= data.current_time.replace(':',''))) {
                        html += `<div class="now-line"><div class="now-dot"></div></div>`;
                    }

                    html += `<div class="time-slot">`;
                    if (showTime) html += `<div class="time-label">${fmtTime12(ev.start)}</div>`;
                    html += `<div class="event-block ${ev._type}">
                        <div class="event-title">${esc(ev.subject)}</div>
                        <div class="event-time">${fmtTime12(ev.start)} ‚Äì ${fmtTime12(ev.end)}${dur>0?' ¬∑ '+fmtDur(dur):''}</div>
                        ${ev.calendar ? `<div class="event-meta">${esc(ev.calendar)}</div>` : ''}
                    </div></div>`;
                    lastEnd = ev.end;
                }

                // NOW line at end if needed
                if (isToday && data.current_time && lastEnd && lastEnd.replace(':','') <= data.current_time.replace(':','')) {
                    html += `<div class="now-line"><div class="now-dot"></div></div>`;
                }

                html += '</div>';
            }

            if (!all.length && !data.all_day?.length) {
                html += '<div style="text-align:center;padding:1.5rem;color:var(--muted)">No events. üå§</div>';
            }

            targetEl.innerHTML = html;
        }

        // ========= TASKS RENDERING =========
        function dueLabel(task) {
            if (!task.due) return null;
            if (task.urgency==='overdue') return {text:`${Math.abs(task.days_until)}d overdue`,cls:'badge-overdue'};
            if (task.urgency==='today') return {text:'Today',cls:'badge-due'};
            if (task.days_until && task.days_until<=7) return {text:`${task.days_until}d`,cls:'badge-due'};
            return null;
        }

        function renderFocusCard(t) {
            const due = dueLabel(t);
            const id = t.id ? `data-task-id="${esc(t.id)}"` : '';
            return `<div class="focus-card" ${id}>
                <button class="card-check" onclick="completeTask(this)" title="Complete"></button>
                <div class="card-body">
                    <div class="card-title">${esc(t.title)}</div>
                    ${t.action?`<div class="card-action">${esc(t.action)}</div>`:''}
                    ${t.why_today?`<div class="card-why">${esc(t.why_today)}</div>`:''}
                    <div class="card-meta">
                        ${t.context?`<span class="badge badge-context">${esc(t.context)}</span>`:''}
                        ${t.time_est?`<span class="badge badge-time">‚è± ${fmtTime(t.time_est)}</span>`:''}
                        ${due?`<span class="badge ${due.cls}">${due.text}</span>`:''}
                        <span class="badge badge-list">${esc(t.list)}</span>
                    </div>
                    ${t.tip?`<div class="card-tip">${esc(t.tip)}</div>`:''}
                </div>
            </div>`;
        }

        function renderWeekCard(t) {
            const due = dueLabel(t);
            const id = t.id ? `data-task-id="${esc(t.id)}"` : '';
            return `<div class="week-card" ${id}>
                <button class="card-check" onclick="completeTask(this)" title="Complete"></button>
                <div class="card-body">
                    <div class="card-title">${esc(t.title)}</div>
                    ${t.action?`<div class="card-action">${esc(t.action)}</div>`:''}
                    <div class="card-meta">
                        ${t.context?`<span class="badge badge-context">${esc(t.context)}</span>`:''}
                        ${t.time_est?`<span class="badge badge-time">‚è± ${fmtTime(t.time_est)}</span>`:''}
                        ${due?`<span class="badge ${due.cls}">${due.text}</span>`:''}
                    </div>
                </div>
            </div>`;
        }

        function renderTasks(data, targetEl) {
            let html = '';
            const fc = (data.today_focus||[]).length;
            const wc = (data.this_week_batches||[]).reduce((s,b)=>s+b.tasks.length,0) + (data.this_week_other||[]).length;
            const waitc = (data.can_wait||[]).length;
            const todayMin = data.today_time||0;
            const availMin = data.available_minutes||90;
            const pct = Math.min(100, Math.round((todayMin/availMin)*100));
            const barColor = pct>90?'var(--accent)':pct>70?'var(--warn)':'var(--primary)';

            html += '<div class="stats-row">';
            html += `<div class="stat"><div class="num" style="color:var(--primary)">${fc}</div><div class="label">Today</div></div>`;
            html += `<div class="stat"><div class="num" style="color:var(--warn)">${wc}</div><div class="label">This Week</div></div>`;
            html += `<div class="stat"><div class="num" style="color:var(--blue)">${waitc}</div><div class="label">Can Wait</div></div>`;
            html += `<div class="stat"><div class="num" style="color:var(--muted)">${data.total_open||0}</div><div class="label">Total</div></div>`;
            html += '</div>';

            html += `<div class="time-bar">
                <div class="time-bar-header"><span>Plan: <strong>${fmtTime(todayMin)}</strong></span><span>Available: <strong>${fmtTime(availMin)}</strong></span></div>
                <div class="time-bar-track"><div class="time-bar-fill" style="width:${pct}%;background:${barColor}"></div></div>
            </div>`;

            // Today focus
            if (data.today_focus?.length) {
                html += `<div class="section-label">üéØ TODAY'S FOCUS <span class="section-count">${fmtTime(todayMin)}</span></div>`;
                html += data.today_focus.map(renderFocusCard).join('');
            }

            // This week
            const weekTotal = wc;
            if (weekTotal > 0) {
                html += `<div class="section-label">üìÖ THIS WEEK <span class="section-count">${weekTotal}</span>
                    <button class="collapse-toggle" onclick="toggle('weekC')">‚ñº</button></div>`;
                html += '<div id="weekC">';
                for (const b of (data.this_week_batches||[])) {
                    const bm = b.tasks.reduce((s,t)=>s+(t.time_est||0),0);
                    html += `<div class="batch-header"><div class="batch-name">üîó ${esc(b.name)}</div>
                        <span class="batch-meta">${b.tasks.length} tasks${bm?' ¬∑ '+fmtTime(bm):''}</span></div>`;
                    html += b.tasks.map(renderWeekCard).join('');
                }
                html += (data.this_week_other||[]).map(renderWeekCard).join('');
                html += '</div>';
            }

            // Can wait
            if (data.can_wait?.length) {
                html += `<div class="section-label">‚è∏ CAN WAIT <span class="section-count">${data.can_wait.length}</span>
                    <button class="collapse-toggle" onclick="toggle('waitC')">‚ñº</button></div>`;
                html += '<div id="waitC" class="collapsed">';
                html += data.can_wait.map(t =>
                    `<div class="wait-item" ${t.id?`data-task-id="${esc(t.id)}"`:''}>
                        <button class="card-check" onclick="completeTask(this)" title="Complete"></button>
                        <span>${esc(t.title)}</span>
                    </div>`).join('');
                html += '</div>';
            }

            // Backlog
            if (data.backlog?.length) {
                const bt = data.backlog.reduce((s,g)=>s+g.tasks.length,0);
                html += `<div class="section-label">üì¶ BACKLOG <span class="section-count">${bt}</span>
                    <button class="collapse-toggle" onclick="toggle('blogC')">‚ñº</button></div>`;
                html += '<div id="blogC" class="collapsed">';
                for (const g of data.backlog) {
                    html += `<div class="backlog-list-name">${esc(g.name)}</div>`;
                    html += g.tasks.map(t =>
                        `<div class="wait-item" ${t.id?`data-task-id="${esc(t.id)}"`:''}>
                            <button class="card-check" onclick="completeTask(this)" title="Complete"></button>
                            <span>${esc(t.title)}</span>
                        </div>`).join('');
                }
                html += '</div>';
            }

            if (!html) html = '<div style="text-align:center;padding:2rem;color:var(--muted)">‚ú® All clear.</div>';
            targetEl.innerHTML = html;
        }

        function toggle(id) { document.getElementById(id)?.classList.toggle('collapsed'); }

        // ========= TASK COMPLETION =========
        async function completeTask(btn) {
            const card = btn.closest('.focus-card, .week-card, .wait-item');
            const tid = card?.dataset?.taskId;
            if (!tid) { showToast('No task ID', true); return; }
            if (btn.classList.contains('completing')) return;
            btn.classList.add('completing'); card.classList.add('completed');
            try {
                const r = await fetch(`/api/tasks/complete?id=${encodeURIComponent(tid)}`,{method:'POST'});
                const d = await r.json();
                if (!r.ok||d.error) { throw new Error(d.error||r.status); }
                showToast(`‚úì ${d.title||'Task'} done`);
                setTimeout(()=>{card.classList.add('removing');setTimeout(()=>card.remove(),700)},400);
            } catch(e) {
                btn.classList.remove('completing'); card.classList.remove('completed');
                btn.classList.add('error'); setTimeout(()=>btn.classList.remove('error'),600);
                showToast(`Failed: ${e.message}`, true);
            }
        }

        // ========= DATA LOADING (progressive) =========
        function updateHeader(sd) {
            const dateObj = new Date(sd.date + 'T12:00:00');
            const dateStr = dateObj.toLocaleDateString('en-US', {weekday:'long',year:'numeric',month:'long',day:'numeric'});
            document.getElementById('title').textContent = `üìã ${sd.day}`;
            document.getElementById('dateStr').innerHTML = dateStr +
                (sd.work_hours
                    ? ` <span class="work-badge">üíº ${fmtTime12(sd.work_hours.start)}‚Äì${fmtTime12(sd.work_hours.end)}</span>`
                    : ` <span class="work-badge off-badge">üå§ Day Off</span>`);
        }

        async function loadAll() {
            const status = document.getElementById('statusText');
            status.textContent = 'Loading...';

            // Fire both simultaneously
            const schedulePromise = fetch('/api/schedule').then(r => r.json());
            const tasksPromise = fetch('/api/tasks/smart').then(r => r.json());

            // Tasks are cached locally ‚Äî arrive fast, render first
            try {
                taskData = await tasksPromise;
                if (taskData.error) throw new Error(taskData.error);
                renderTasks(taskData, document.getElementById('combined-tasks'));
                renderTasks(taskData, document.getElementById('tasks-full'));
                lastGenerated = taskData.generated || '';
                status.textContent = taskData.from_cache
                    ? `Tasks loaded ¬∑ loading calendar...`
                    : 'Tasks loaded ¬∑ loading calendar...';
            } catch(e) {
                document.getElementById('combined-tasks').innerHTML =
                    `<div style="text-align:center;padding:1.5rem;color:var(--accent)">‚ö†Ô∏è Tasks: ${esc(e.message)}<br><small>Retrying in 10s...</small></div>`;
                setTimeout(loadAll, 10000);
            }

            // Schedule makes 10 live API calls ‚Äî arrives after, fills in
            try {
                scheduleData = await schedulePromise;
                if (scheduleData.error) throw new Error(scheduleData.error);
                updateHeader(scheduleData);
                renderSchedule(scheduleData, document.getElementById('combined-schedule'), true);
                renderSchedule(scheduleData, document.getElementById('schedule-full'), false);
                status.textContent = taskData?.from_cache
                    ? `Cached (${Math.floor(taskData.cache_age/60)}m) ¬∑ live`
                    : 'Fresh ¬∑ live';
            } catch(e) {
                document.getElementById('combined-schedule').innerHTML =
                    `<div style="text-align:center;padding:1rem;color:var(--accent)">‚ö†Ô∏è Calendar: ${esc(e.message)}</div>`;
            }
        }

        async function fullRefresh() {
            const fab = document.getElementById('fabRefresh');
            if (fab.classList.contains('syncing')) return;
            fab.classList.add('syncing');
            document.getElementById('statusText').textContent = 'Re-analyzing...';
            try {
                await fetch('/api/tasks/refresh');
                const [sR, tR] = await Promise.all([
                    fetch('/api/schedule'),
                    fetch('/api/tasks/smart?force')
                ]);
                scheduleData = await sR.json();
                taskData = await tR.json();
                renderSchedule(scheduleData, document.getElementById('combined-schedule'), true);
                renderTasks(taskData, document.getElementById('combined-tasks'));
                renderSchedule(scheduleData, document.getElementById('schedule-full'), false);
                renderTasks(taskData, document.getElementById('tasks-full'));
                document.getElementById('statusText').textContent = 'Fresh ¬∑ just now';
                showToast('Re-analyzed ‚úì');
            } catch(e) { showToast(`Failed: ${e.message}`, true); }
            finally { fab.classList.remove('syncing'); }
        }

        async function syncOnly() {
            const fab = document.getElementById('fabSync');
            if (fab.classList.contains('syncing')) return;
            fab.classList.add('syncing');
            document.getElementById('statusText').textContent = 'Syncing...';
            try {
                await fetch('/api/tasks/refresh');
                await loadAll();
                showToast('Synced ‚úì');
            } catch(e) { showToast(`Failed: ${e.message}`, true); }
            finally { fab.classList.remove('syncing'); }
        }

        function navDay(offset) {
            const d = new Date(currentDate+'T12:00:00');
            d.setDate(d.getDate()+offset);
            currentDate = d.toISOString().slice(0,10);
            fetch(`/api/schedule?date=${currentDate}`).then(r=>r.json()).then(data=>{
                scheduleData = data;
                renderSchedule(data, document.getElementById('schedule-full'), false);
            });
        }
        function navToday() {
            currentDate = new Date().toISOString().slice(0,10);
            fetch('/api/schedule').then(r=>r.json()).then(data=>{
                scheduleData = data;
                renderSchedule(data, document.getElementById('schedule-full'), false);
            });
        }

        // Init + auto-refresh
        loadAll();
        setInterval(async()=>{
            try {
                const [sR,tR] = await Promise.all([fetch('/api/schedule'), fetch('/api/tasks/smart')]);
                const sd = await sR.json(), td = await tR.json();
                if (td.error||sd.error) return;
                if (lastGenerated && td.generated !== lastGenerated) {
                    scheduleData=sd; taskData=td;
                    renderSchedule(sd, document.getElementById('combined-schedule'), true);
                    renderTasks(td, document.getElementById('combined-tasks'));
                    renderSchedule(sd, document.getElementById('schedule-full'), false);
                    renderTasks(td, document.getElementById('tasks-full'));
                    showToast('Auto-updated ‚úì');
                    document.getElementById('statusText').textContent = 'Live ¬∑ auto-updated';
                }
                lastGenerated = td.generated;
                // Always update schedule (current_time changes)
                scheduleData=sd;
                renderSchedule(sd, document.getElementById('combined-schedule'), true);
            } catch{}
        }, 30000);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Today ‚Äî Smart View | Snippy</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg: #0a0a1a; --surface: #111127; --surface2: #1a1a35;
            --border: #2a2a4a; --primary: #00d4aa; --accent: #ff6b6b;
            --warn: #f59e0b; --purple: #a78bfa; --blue: #60a5fa;
            --text: #e4e4e7; --muted: #7a8a9a;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg); color: var(--text);
            min-height: 100vh; line-height: 1.6;
        }
        .container { max-width: 720px; margin: 0 auto; padding: 32px 20px 100px; }
        .back-link {
            display: inline-flex; align-items: center; gap: 6px;
            color: var(--muted); text-decoration: none; font-size: 0.9rem;
            margin-bottom: 1.5rem; transition: color 0.2s;
        }
        .back-link:hover { color: var(--primary); }

        /* Header */
        .header { margin-bottom: 2rem; }
        .header h1 { font-size: 1.8rem; font-weight: 700; margin-bottom: 4px; }
        .header .date { color: var(--muted); font-size: 1rem; }
        .stats-row {
            display: flex; gap: 16px; margin-top: 1rem; flex-wrap: wrap;
        }
        .stat {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 10px; padding: 10px 16px; text-align: center; flex: 1; min-width: 80px;
        }
        .stat .num { font-size: 1.4rem; font-weight: 700; color: var(--primary); }
        .stat .label { font-size: 0.72rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }

        .status-bar {
            display: flex; align-items: center; gap: 8px;
            margin-top: 1rem; font-size: 0.8rem; color: var(--muted);
        }
        .status-dot {
            width: 8px; height: 8px; border-radius: 50%;
            background: var(--primary); animation: pulse 2s infinite;
        }
        @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.3; } }

        /* Batch Group */
        .batch-group { margin-bottom: 1.5rem; }
        .batch-header {
            display: flex; align-items: center; gap: 10px;
            padding: 10px 0; margin-bottom: 8px;
            border-bottom: 2px solid var(--border);
        }
        .batch-name { font-size: 1.05rem; font-weight: 700; flex: 1; }
        .batch-count {
            font-size: 0.75rem; background: var(--surface2); color: var(--muted);
            padding: 3px 10px; border-radius: 12px;
        }
        .batch-time {
            font-size: 0.75rem; color: var(--primary);
            font-family: 'SF Mono', Monaco, monospace;
        }

        /* Task Card ‚Äî Smart */
        .smart-card {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 12px; padding: 14px 16px; margin-bottom: 8px;
            transition: all 0.2s; display: flex; gap: 12px;
        }
        .smart-card:hover { border-color: var(--primary); }

        .card-check {
            width: 22px; height: 22px; border: 2px solid var(--muted);
            border-radius: 6px; flex-shrink: 0; margin-top: 2px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.2s; background: transparent; padding: 0;
        }
        .card-check:hover { border-color: var(--primary); background: rgba(0,212,170,0.1); }
        .card-check.completing { border-color: var(--primary); background: var(--primary); animation: checkPop 0.3s ease; }
        .card-check.completing::after { content: '‚úì'; color: var(--bg); font-size: 14px; font-weight: 700; }
        .card-check.error { border-color: var(--accent); animation: shake 0.3s ease; }

        .smart-card.completed { opacity: 0.4; transform: scale(0.98); }
        .smart-card.completed .card-title { text-decoration: line-through; }
        .smart-card.removing { opacity: 0; max-height: 0; padding: 0; margin: 0; overflow: hidden; transition: all 0.5s ease 0.2s; }

        @keyframes checkPop { 0%{transform:scale(1)} 50%{transform:scale(1.2)} 100%{transform:scale(1)} }
        @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-4px)} 75%{transform:translateX(4px)} }

        .card-body { flex: 1; min-width: 0; }
        .card-top { display: flex; align-items: flex-start; gap: 8px; margin-bottom: 6px; }
        .card-title { font-weight: 600; font-size: 0.95rem; flex: 1; }
        .card-score {
            font-size: 0.7rem; font-weight: 700; padding: 2px 7px;
            border-radius: 6px; flex-shrink: 0;
        }
        .score-high { background: rgba(255,107,107,0.15); color: var(--accent); }
        .score-med { background: rgba(245,158,11,0.15); color: var(--warn); }
        .score-low { background: rgba(0,212,170,0.15); color: var(--primary); }

        .card-action {
            font-size: 0.85rem; color: var(--primary); margin-bottom: 6px;
            padding: 6px 10px; background: rgba(0,212,170,0.06);
            border-radius: 6px; border-left: 3px solid var(--primary);
        }
        .card-action::before { content: '‚Üí '; font-weight: 700; }

        .card-meta { display: flex; flex-wrap: wrap; gap: 6px; align-items: center; }
        .badge {
            font-size: 0.72rem; padding: 2px 8px; border-radius: 6px; white-space: nowrap;
        }
        .badge-context { background: rgba(167,139,250,0.12); color: var(--purple); }
        .badge-time { background: rgba(96,165,250,0.12); color: var(--blue); }
        .badge-due { background: rgba(245,158,11,0.12); color: var(--warn); }
        .badge-overdue { background: rgba(255,107,107,0.15); color: var(--accent); }
        .badge-list { background: rgba(255,255,255,0.05); color: var(--muted); }

        .card-tip {
            font-size: 0.78rem; color: var(--muted); margin-top: 6px;
            font-style: italic;
        }
        .card-tip::before { content: 'üí° '; }

        /* Section Labels */
        .section-label {
            font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1.5px;
            color: var(--muted); margin: 2rem 0 0.75rem; padding-bottom: 6px;
            border-bottom: 1px solid var(--border);
        }

        /* Backlog ‚Äî compact */
        .backlog-group { margin-bottom: 1rem; }
        .backlog-list-name {
            font-size: 0.8rem; font-weight: 600; color: var(--muted);
            margin-bottom: 6px;
        }
        .backlog-item {
            display: flex; align-items: center; gap: 10px;
            padding: 8px 12px; background: var(--surface);
            border: 1px solid var(--border); border-radius: 8px;
            margin-bottom: 4px; font-size: 0.85rem; transition: all 0.2s;
        }
        .backlog-item:hover { border-color: var(--border); }

        /* Loading */
        .loading { text-align: center; padding: 4rem 0; color: var(--muted); }
        .loading-spinner {
            width: 40px; height: 40px; border: 3px solid var(--border);
            border-top-color: var(--primary); border-radius: 50%;
            animation: spin 0.8s linear infinite; margin: 0 auto 1rem;
        }
        .loading-sub { font-size: 0.85rem; margin-top: 8px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Toast */
        .toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            padding: 10px 20px; border-radius: 8px; font-size: 0.9rem; z-index: 999;
            font-weight: 500; box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: opacity 0.3s;
        }

        /* Floating buttons */
        .fab-group { position: fixed; bottom: 24px; right: 24px; display: flex; flex-direction: column; gap: 10px; z-index: 100; }
        .fab {
            width: 48px; height: 48px; border-radius: 50%; border: none;
            color: var(--bg); font-size: 1.2rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .fab:hover { transform: scale(1.1); }
        .fab:active { transform: scale(0.95); }
        .fab-sync { background: var(--primary); }
        .fab-refresh { background: var(--purple); }
        .fab.syncing { pointer-events: none; background: var(--surface2); }
        .fab.syncing .fab-icon { animation: spin 0.8s linear infinite; }

        @media (max-width: 640px) {
            .container { padding: 24px 16px 100px; }
            .header h1 { font-size: 1.5rem; }
            .stats-row { gap: 8px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/private/" class="back-link">‚Üê Dashboard</a>

        <div class="header">
            <h1 id="title">‚è≥ Analyzing tasks...</h1>
            <div class="date" id="dateStr"></div>
            <div class="stats-row" id="stats" style="display:none">
                <div class="stat"><div class="num" id="statActionable">-</div><div class="label">Actionable</div></div>
                <div class="stat"><div class="num" id="statTime">-</div><div class="label">Est. Time</div></div>
                <div class="stat"><div class="num" id="statBatches">-</div><div class="label">Batches</div></div>
                <div class="stat"><div class="num" id="statTotal">-</div><div class="label">Total Open</div></div>
            </div>
            <div class="status-bar" id="statusBar">
                <div class="status-dot"></div>
                <span id="statusText">Loading...</span>
            </div>
        </div>

        <div id="content">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>Loading tasks from cache...</p>
                <p class="loading-sub" id="loadingSub">Then enriching with AI analysis</p>
            </div>
        </div>
    </div>

    <div class="fab-group">
        <button class="fab fab-refresh" id="fabRefresh" onclick="fullRefresh()" title="Re-analyze with AI">
            <span class="fab-icon">üß†</span>
        </button>
        <button class="fab fab-sync" id="fabSync" onclick="syncOnly()" title="Sync MS To Do">
            <span class="fab-icon">üîÑ</span>
        </button>
    </div>

    <script>
        function esc(s) { const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }

        function formatTime(min) {
            if (min < 60) return `${min}m`;
            const h = Math.floor(min/60), m = min%60;
            return m ? `${h}h ${m}m` : `${h}h`;
        }

        function dueLabel(task) {
            if (!task.due) return null;
            if (task.urgency === 'overdue') return { text: `${Math.abs(task.days_until)}d overdue`, cls: 'badge-overdue' };
            if (task.urgency === 'today') return { text: 'Today', cls: 'badge-due' };
            if (task.days_until <= 7) return { text: `${task.days_until}d`, cls: 'badge-due' };
            return null;
        }

        function scoreClass(s) {
            if (s >= 8) return 'score-high';
            if (s >= 5) return 'score-med';
            return 'score-low';
        }

        function renderSmartCard(task) {
            const due = dueLabel(task);
            const score = task.priority_score || 5;
            const id = task.id ? `data-task-id="${esc(task.id)}"` : '';

            return `<div class="smart-card" ${id}>
                <button class="card-check" onclick="completeTask(this)" title="Complete"></button>
                <div class="card-body">
                    <div class="card-top">
                        <div class="card-title">${esc(task.title)}</div>
                        <span class="card-score ${scoreClass(score)}">${score}/10</span>
                    </div>
                    ${task.action ? `<div class="card-action">${esc(task.action)}</div>` : ''}
                    <div class="card-meta">
                        ${task.context ? `<span class="badge badge-context">${esc(task.context)}</span>` : ''}
                        ${task.time_est ? `<span class="badge badge-time">‚è± ${formatTime(task.time_est)}</span>` : ''}
                        ${due ? `<span class="badge ${due.cls}">${due.text}</span>` : ''}
                        <span class="badge badge-list">${esc(task.list)}</span>
                    </div>
                    ${task.tip ? `<div class="card-tip">${esc(task.tip)}</div>` : ''}
                </div>
            </div>`;
        }

        function renderBatch(batch) {
            const totalMin = batch.tasks.reduce((s,t) => s + (t.time_est||0), 0);
            return `<div class="batch-group">
                <div class="batch-header">
                    <div class="batch-name">${esc(batch.name)}</div>
                    <span class="batch-count">${batch.tasks.length} tasks</span>
                    ${totalMin ? `<span class="batch-time">${formatTime(totalMin)}</span>` : ''}
                </div>
                ${batch.tasks.map(t => renderSmartCard(t)).join('')}
            </div>`;
        }

        function renderData(data) {
            document.getElementById('title').textContent = `üìã ${data.day}'s Game Plan`;
            document.getElementById('dateStr').textContent = new Date(data.date + 'T00:00:00')
                .toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

            // Stats
            const stats = document.getElementById('stats');
            stats.style.display = 'flex';
            document.getElementById('statActionable').textContent = data.total_actionable || 0;
            document.getElementById('statTime').textContent = formatTime(data.time_total_est || 0);
            document.getElementById('statBatches').textContent = (data.batches||[]).length;
            document.getElementById('statTotal').textContent = data.total_open || 0;

            let html = '';

            // Batched tasks
            if (data.batches && data.batches.length > 0) {
                html += '<div class="section-label">üéØ Smart Groups</div>';
                html += data.batches.map(b => renderBatch(b)).join('');
            }

            // Unbatched actionable
            if (data.unbatched && data.unbatched.length > 0) {
                html += '<div class="section-label">üìå Individual Tasks</div>';
                html += data.unbatched.map(t => renderSmartCard(t)).join('');
            }

            // Backlog
            if (data.backlog && data.backlog.length > 0) {
                html += '<div class="section-label">üì¶ Backlog</div>';
                for (const group of data.backlog) {
                    html += `<div class="backlog-group">
                        <div class="backlog-list-name">${esc(group.name)}</div>
                        ${group.tasks.map(t => `<div class="backlog-item" ${t.id ? `data-task-id="${esc(t.id)}"` : ''}>
                            <button class="card-check" onclick="completeTask(this)" title="Complete" style="width:18px;height:18px;min-width:18px"></button>
                            <span>${esc(t.title)}</span>
                        </div>`).join('')}
                    </div>`;
                }
            }

            if (!html) html = '<div style="text-align:center;padding:3rem;color:var(--muted)">‚ú® Nothing to do. Nice.</div>';

            document.getElementById('content').innerHTML = html;
        }

        function showToast(msg, isError) {
            const t = document.createElement('div');
            t.className = 'toast';
            t.style.background = isError ? 'rgba(255,107,107,0.95)' : 'rgba(0,212,170,0.95)';
            t.style.color = isError ? '#fff' : '#0a0a1a';
            t.textContent = msg;
            document.body.appendChild(t);
            setTimeout(() => { t.style.opacity='0'; setTimeout(()=>t.remove(),300); }, 3000);
        }

        async function completeTask(btn) {
            const card = btn.closest('.smart-card, .backlog-item');
            const taskId = card?.dataset?.taskId;
            if (!taskId) { showToast('No task ID', true); return; }
            if (btn.classList.contains('completing')) return;

            btn.classList.add('completing');
            card.classList.add('completed');

            try {
                const r = await fetch(`/api/tasks/complete?id=${encodeURIComponent(taskId)}`, { method: 'POST' });
                const text = await r.text();
                let data; try { data = JSON.parse(text); } catch { data = { error: text }; }

                if (!r.ok || data.error) {
                    btn.classList.remove('completing');
                    card.classList.remove('completed');
                    btn.classList.add('error');
                    setTimeout(() => btn.classList.remove('error'), 600);
                    showToast(`Failed: ${data.error || r.status}`, true);
                    return;
                }

                showToast(`‚úì ${data.title || 'Task'} done`, false);
                setTimeout(() => {
                    card.classList.add('removing');
                    setTimeout(() => {
                        const parent = card.closest('.batch-group, .backlog-group');
                        card.remove();
                        if (parent && parent.querySelectorAll('.smart-card, .backlog-item').length === 0) parent.remove();
                    }, 700);
                }, 400);
            } catch (e) {
                btn.classList.remove('completing');
                card.classList.remove('completed');
                showToast(`Error: ${e.message}`, true);
            }
        }

        async function init() {
            const status = document.getElementById('statusText');
            try {
                // Try cached smart data first
                status.textContent = 'Loading smart view...';
                const r = await fetch('/api/tasks/smart');
                if (!r.ok) throw new Error(`HTTP ${r.status}`);
                const data = await r.json();
                if (data.error) throw new Error(data.error);

                renderData(data);

                if (data.from_cache) {
                    status.textContent = `Cached (${Math.floor(data.cache_age/60)}m old) ¬∑ Tap üß† to refresh`;
                } else {
                    status.textContent = 'Fresh analysis ¬∑ AI-enriched';
                }
            } catch (e) {
                document.getElementById('content').innerHTML =
                    `<div style="text-align:center;padding:2rem;color:var(--accent)">‚ö†Ô∏è ${esc(e.message)}<br><small>Retrying in 10s...</small></div>`;
                status.textContent = 'Error loading';
                setTimeout(init, 10000);
            }
        }

        async function fullRefresh() {
            const fab = document.getElementById('fabRefresh');
            const status = document.getElementById('statusText');
            if (fab.classList.contains('syncing')) return;
            fab.classList.add('syncing');
            status.textContent = 'Syncing + re-analyzing...';

            try {
                // First sync MS To Do
                await fetch('/api/tasks/refresh');
                // Then re-enrich with --force
                const r = await fetch('/api/tasks/smart?force');
                const data = await r.json();
                if (data.error) throw new Error(data.error);
                renderData(data);
                status.textContent = 'Fresh analysis ¬∑ just now';
                showToast('Re-analyzed ‚úì', false);
            } catch (e) {
                status.textContent = 'Refresh failed';
                showToast(`Failed: ${e.message}`, true);
            } finally {
                fab.classList.remove('syncing');
            }
        }

        async function syncOnly() {
            const fab = document.getElementById('fabSync');
            const status = document.getElementById('statusText');
            if (fab.classList.contains('syncing')) return;
            fab.classList.add('syncing');
            status.textContent = 'Syncing MS To Do...';

            try {
                await fetch('/api/tasks/refresh');
                const r = await fetch('/api/tasks/smart');
                const data = await r.json();
                renderData(data);
                status.textContent = 'Synced ¬∑ cached analysis';
                showToast('Synced ‚úì', false);
            } catch (e) {
                showToast(`Sync failed: ${e.message}`, true);
            } finally {
                fab.classList.remove('syncing');
            }
        }

        init();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Today ‚Äî Smart View | Snippy</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg: #0a0a1a; --surface: #111127; --surface2: #1a1a35;
            --border: #2a2a4a; --primary: #00d4aa; --accent: #ff6b6b;
            --warn: #f59e0b; --purple: #a78bfa; --blue: #60a5fa;
            --text: #e4e4e7; --muted: #7a8a9a;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg); color: var(--text);
            min-height: 100vh; line-height: 1.6;
        }
        .container { max-width: 720px; margin: 0 auto; padding: 32px 20px 100px; }
        .back-link {
            display: inline-flex; align-items: center; gap: 6px;
            color: var(--muted); text-decoration: none; font-size: 0.9rem;
            margin-bottom: 1.5rem; transition: color 0.2s;
        }
        .back-link:hover { color: var(--primary); }

        /* Header */
        .header { margin-bottom: 2rem; }
        .header h1 { font-size: 1.8rem; font-weight: 700; margin-bottom: 4px; }
        .header .date { color: var(--muted); font-size: 1rem; margin-bottom: 4px; }
        .header .day-context { font-size: 0.85rem; color: var(--primary); }

        .stats-row { display: flex; gap: 12px; margin-top: 1rem; flex-wrap: wrap; }
        .stat {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 10px; padding: 10px 16px; text-align: center; flex: 1; min-width: 70px;
        }
        .stat .num { font-size: 1.3rem; font-weight: 700; }
        .stat .num.green { color: var(--primary); }
        .stat .num.yellow { color: var(--warn); }
        .stat .num.blue { color: var(--blue); }
        .stat .label { font-size: 0.68rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }

        .time-bar {
            margin-top: 1rem; background: var(--surface); border: 1px solid var(--border);
            border-radius: 10px; padding: 12px 16px;
        }
        .time-bar-header { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--muted); margin-bottom: 6px; }
        .time-bar-track { height: 8px; background: var(--surface2); border-radius: 4px; overflow: hidden; }
        .time-bar-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }

        .status-bar {
            display: flex; align-items: center; gap: 8px;
            margin-top: 0.75rem; font-size: 0.8rem; color: var(--muted);
        }
        .status-dot {
            width: 8px; height: 8px; border-radius: 50%;
            background: var(--primary); animation: pulse 2s infinite;
        }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }

        /* Section */
        .section-label {
            font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1.5px;
            color: var(--muted); margin: 2rem 0 0.75rem; padding-bottom: 6px;
            border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 8px;
        }
        .section-count { font-size: 0.7rem; background: var(--surface2); padding: 2px 8px; border-radius: 10px; }

        /* Focus Card (Today's Top Items) */
        .focus-card {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 14px; padding: 16px 18px; margin-bottom: 10px;
            transition: all 0.2s; display: flex; gap: 12px;
            border-left: 4px solid var(--primary);
        }
        .focus-card:hover { border-color: var(--primary); }

        .card-check {
            width: 24px; height: 24px; border: 2px solid var(--muted);
            border-radius: 7px; flex-shrink: 0; margin-top: 1px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.2s; background: transparent; padding: 0;
        }
        .card-check:hover { border-color: var(--primary); background: rgba(0,212,170,0.1); }
        .card-check.completing { border-color: var(--primary); background: var(--primary); animation: checkPop 0.3s ease; }
        .card-check.completing::after { content: '‚úì'; color: var(--bg); font-size: 14px; font-weight: 700; }
        .card-check.error { border-color: var(--accent); animation: shake 0.3s ease; }
        .focus-card.completed, .week-card.completed, .wait-item.completed { opacity: 0.35; }
        .focus-card.completed .card-title, .week-card.completed .card-title { text-decoration: line-through; }
        .focus-card.removing, .week-card.removing, .wait-item.removing {
            opacity: 0; max-height: 0; padding: 0; margin: 0; overflow: hidden;
            transition: all 0.5s ease 0.2s;
        }

        @keyframes checkPop { 0%{transform:scale(1)} 50%{transform:scale(1.2)} 100%{transform:scale(1)} }
        @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-4px)} 75%{transform:translateX(4px)} }

        .card-body { flex: 1; min-width: 0; }
        .card-title { font-weight: 600; font-size: 0.95rem; margin-bottom: 4px; }

        .card-action {
            font-size: 0.85rem; color: var(--primary); margin-bottom: 8px;
            padding: 8px 12px; background: rgba(0,212,170,0.06);
            border-radius: 8px; border-left: 3px solid var(--primary);
        }
        .card-action::before { content: '‚Üí '; font-weight: 700; }

        .card-why {
            font-size: 0.8rem; color: var(--warn); margin-bottom: 6px;
        }
        .card-why::before { content: '‚ö° '; }

        .card-meta { display: flex; flex-wrap: wrap; gap: 6px; align-items: center; }
        .badge { font-size: 0.72rem; padding: 2px 8px; border-radius: 6px; white-space: nowrap; }
        .badge-context { background: rgba(167,139,250,0.12); color: var(--purple); }
        .badge-time { background: rgba(96,165,250,0.12); color: var(--blue); }
        .badge-due { background: rgba(245,158,11,0.12); color: var(--warn); }
        .badge-overdue { background: rgba(255,107,107,0.15); color: var(--accent); }
        .badge-list { background: rgba(255,255,255,0.05); color: var(--muted); }

        .card-tip { font-size: 0.78rem; color: var(--muted); margin-top: 8px; font-style: italic; }
        .card-tip::before { content: 'üí° '; }

        /* Week Card (smaller) */
        .week-card {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 10px; padding: 12px 14px; margin-bottom: 6px;
            display: flex; gap: 10px; transition: all 0.2s;
        }
        .week-card:hover { border-color: rgba(255,255,255,0.1); }
        .week-card .card-title { font-size: 0.9rem; }
        .week-card .card-action { font-size: 0.82rem; padding: 6px 10px; margin-bottom: 6px; }

        /* Batch header */
        .batch-header {
            display: flex; align-items: center; gap: 10px;
            padding: 8px 0; margin: 12px 0 6px; border-bottom: 1px dashed var(--border);
        }
        .batch-name { font-size: 0.9rem; font-weight: 600; flex: 1; }
        .batch-meta { font-size: 0.72rem; color: var(--muted); }

        /* Can Wait / Backlog ‚Äî minimal */
        .wait-item {
            display: flex; align-items: center; gap: 10px;
            padding: 8px 12px; background: var(--surface);
            border: 1px solid var(--border); border-radius: 8px;
            margin-bottom: 4px; font-size: 0.85rem; transition: all 0.2s;
        }
        .wait-item .card-check { width: 18px; height: 18px; min-width: 18px; }

        .backlog-list-name { font-size: 0.78rem; font-weight: 600; color: var(--muted); margin: 10px 0 4px; }

        /* Collapsible */
        .collapse-toggle {
            background: none; border: none; color: var(--muted); cursor: pointer;
            font-size: 0.75rem; padding: 4px 8px; border-radius: 6px;
            transition: all 0.2s;
        }
        .collapse-toggle:hover { color: var(--text); background: var(--surface2); }
        .collapsed { display: none; }

        /* Loading */
        .loading { text-align: center; padding: 4rem 0; color: var(--muted); }
        .loading-spinner {
            width: 40px; height: 40px; border: 3px solid var(--border);
            border-top-color: var(--primary); border-radius: 50%;
            animation: spin 0.8s linear infinite; margin: 0 auto 1rem;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            padding: 10px 20px; border-radius: 8px; font-size: 0.9rem; z-index: 999;
            font-weight: 500; box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: opacity 0.3s;
        }

        .fab-group { position: fixed; bottom: 24px; right: 24px; display: flex; flex-direction: column; gap: 10px; z-index: 100; }
        .fab {
            width: 48px; height: 48px; border-radius: 50%; border: none;
            color: var(--bg); font-size: 1.2rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .fab:hover { transform: scale(1.1); }
        .fab:active { transform: scale(0.95); }
        .fab-sync { background: var(--primary); }
        .fab-refresh { background: var(--purple); }
        .fab.syncing { pointer-events: none; background: var(--surface2); }
        .fab.syncing .fab-icon { animation: spin 0.8s linear infinite; }

        @media (max-width: 640px) {
            .container { padding: 24px 16px 100px; }
            .header h1 { font-size: 1.5rem; }
            .stats-row { gap: 8px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/private/" class="back-link">‚Üê Dashboard</a>

        <div class="header">
            <h1 id="title">‚è≥ Building your game plan...</h1>
            <div class="date" id="dateStr"></div>
            <div class="day-context" id="dayContext"></div>

            <div class="stats-row" id="stats" style="display:none">
                <div class="stat"><div class="num green" id="statFocus">-</div><div class="label">Today</div></div>
                <div class="stat"><div class="num yellow" id="statWeek">-</div><div class="label">This Week</div></div>
                <div class="stat"><div class="num blue" id="statWait">-</div><div class="label">Can Wait</div></div>
                <div class="stat"><div class="num" style="color:var(--muted)" id="statTotal">-</div><div class="label">Total</div></div>
            </div>

            <div class="time-bar" id="timeBar" style="display:none">
                <div class="time-bar-header">
                    <span>Today's plan: <strong id="todayTime">-</strong></span>
                    <span>Available: <strong id="availTime">-</strong></span>
                </div>
                <div class="time-bar-track">
                    <div class="time-bar-fill" id="timeFill" style="width:0%"></div>
                </div>
            </div>

            <div class="status-bar">
                <div class="status-dot"></div>
                <span id="statusText">Loading...</span>
            </div>
        </div>

        <div id="content">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>Analyzing your tasks with AI...</p>
            </div>
        </div>
    </div>

    <div class="fab-group">
        <button class="fab fab-refresh" id="fabRefresh" onclick="fullRefresh()" title="Re-analyze with AI">
            <span class="fab-icon">üß†</span>
        </button>
        <button class="fab fab-sync" id="fabSync" onclick="syncOnly()" title="Sync MS To Do">
            <span class="fab-icon">üîÑ</span>
        </button>
    </div>

    <script>
        function esc(s) { if(!s) return ''; const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }
        function formatTime(min) {
            if (!min) return '0m';
            if (min < 60) return `${min}m`;
            const h=Math.floor(min/60), m=min%60;
            return m ? `${h}h ${m}m` : `${h}h`;
        }
        function dueLabel(task) {
            if (!task.due) return null;
            if (task.urgency==='overdue') return {text:`${Math.abs(task.days_until)}d overdue`,cls:'badge-overdue'};
            if (task.urgency==='today') return {text:'Today',cls:'badge-due'};
            if (task.days_until && task.days_until<=7) return {text:`${task.days_until}d`,cls:'badge-due'};
            return null;
        }

        function showToast(msg, isError) {
            const t=document.createElement('div');
            t.className='toast';
            t.style.background=isError?'rgba(255,107,107,0.95)':'rgba(0,212,170,0.95)';
            t.style.color=isError?'#fff':'#0a0a1a';
            t.textContent=msg;
            document.body.appendChild(t);
            setTimeout(()=>{t.style.opacity='0';setTimeout(()=>t.remove(),300)},3000);
        }

        function renderFocusCard(task) {
            const due = dueLabel(task);
            const id = task.id ? `data-task-id="${esc(task.id)}"` : '';
            return `<div class="focus-card" ${id}>
                <button class="card-check" onclick="completeTask(this)" title="Complete"></button>
                <div class="card-body">
                    <div class="card-title">${esc(task.title)}</div>
                    ${task.action ? `<div class="card-action">${esc(task.action)}</div>` : ''}
                    ${task.why_today ? `<div class="card-why">${esc(task.why_today)}</div>` : ''}
                    <div class="card-meta">
                        ${task.context ? `<span class="badge badge-context">${esc(task.context)}</span>` : ''}
                        ${task.time_est ? `<span class="badge badge-time">‚è± ${formatTime(task.time_est)}</span>` : ''}
                        ${due ? `<span class="badge ${due.cls}">${due.text}</span>` : ''}
                        <span class="badge badge-list">${esc(task.list)}</span>
                    </div>
                    ${task.tip ? `<div class="card-tip">${esc(task.tip)}</div>` : ''}
                </div>
            </div>`;
        }

        function renderWeekCard(task) {
            const due = dueLabel(task);
            const id = task.id ? `data-task-id="${esc(task.id)}"` : '';
            return `<div class="week-card" ${id}>
                <button class="card-check" onclick="completeTask(this)" title="Complete"></button>
                <div class="card-body">
                    <div class="card-title">${esc(task.title)}</div>
                    ${task.action ? `<div class="card-action">${esc(task.action)}</div>` : ''}
                    <div class="card-meta">
                        ${task.context ? `<span class="badge badge-context">${esc(task.context)}</span>` : ''}
                        ${task.time_est ? `<span class="badge badge-time">‚è± ${formatTime(task.time_est)}</span>` : ''}
                        ${due ? `<span class="badge ${due.cls}">${due.text}</span>` : ''}
                    </div>
                </div>
            </div>`;
        }

        function renderData(data) {
            document.getElementById('title').textContent = `üìã ${data.day}'s Game Plan`;
            document.getElementById('dateStr').textContent = new Date(data.date+'T00:00:00')
                .toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'});

            const ctx = data.is_weekend
                ? 'üå§ Weekend ‚Äî primary project window'
                : 'üíº Workday ‚Äî limited personal time';
            document.getElementById('dayContext').textContent = ctx;

            // Stats
            const focusCount = (data.today_focus||[]).length;
            const weekCount = (data.this_week_batches||[]).reduce((s,b)=>s+b.tasks.length,0) + (data.this_week_other||[]).length;
            const waitCount = (data.can_wait||[]).length;

            document.getElementById('stats').style.display = 'flex';
            document.getElementById('statFocus').textContent = focusCount;
            document.getElementById('statWeek').textContent = weekCount;
            document.getElementById('statWait').textContent = waitCount;
            document.getElementById('statTotal').textContent = data.total_open || 0;

            // Time bar
            const todayMin = data.today_time || 0;
            const availMin = data.available_minutes || 90;
            const pct = Math.min(100, Math.round((todayMin/availMin)*100));
            const barColor = pct > 90 ? 'var(--accent)' : pct > 70 ? 'var(--warn)' : 'var(--primary)';

            document.getElementById('timeBar').style.display = 'block';
            document.getElementById('todayTime').textContent = formatTime(todayMin);
            document.getElementById('availTime').textContent = formatTime(availMin);
            const fill = document.getElementById('timeFill');
            fill.style.width = pct + '%';
            fill.style.background = barColor;

            let html = '';

            // Today's Focus
            if (data.today_focus && data.today_focus.length > 0) {
                html += `<div class="section-label">üéØ TODAY'S FOCUS <span class="section-count">${formatTime(todayMin)}</span></div>`;
                html += data.today_focus.map(t => renderFocusCard(t)).join('');
            }

            // This Week ‚Äî batches
            if ((data.this_week_batches && data.this_week_batches.length > 0) || (data.this_week_other && data.this_week_other.length > 0)) {
                html += `<div class="section-label">üìÖ THIS WEEK <span class="section-count">${weekCount} tasks</span>
                    <button class="collapse-toggle" onclick="toggleSection('weekContent')">‚ñº</button></div>`;
                html += '<div id="weekContent">';

                for (const batch of (data.this_week_batches||[])) {
                    const batchMin = batch.tasks.reduce((s,t)=>s+(t.time_est||0),0);
                    html += `<div class="batch-header">
                        <div class="batch-name">üîó ${esc(batch.name)}</div>
                        <span class="batch-meta">${batch.tasks.length} tasks${batchMin ? ' ¬∑ '+formatTime(batchMin) : ''}</span>
                    </div>`;
                    html += batch.tasks.map(t => renderWeekCard(t)).join('');
                }

                html += (data.this_week_other||[]).map(t => renderWeekCard(t)).join('');
                html += '</div>';
            }

            // Can Wait
            if (data.can_wait && data.can_wait.length > 0) {
                html += `<div class="section-label">‚è∏ CAN WAIT <span class="section-count">${data.can_wait.length}</span>
                    <button class="collapse-toggle" onclick="toggleSection('waitContent')">‚ñº</button></div>`;
                html += '<div id="waitContent" class="collapsed">';
                html += data.can_wait.map(t =>
                    `<div class="wait-item" ${t.id?`data-task-id="${esc(t.id)}"`:''}">
                        <button class="card-check" onclick="completeTask(this)" title="Complete"></button>
                        <span>${esc(t.title)}</span>
                    </div>`
                ).join('');
                html += '</div>';
            }

            // Backlog
            if (data.backlog && data.backlog.length > 0) {
                const backlogTotal = data.backlog.reduce((s,g)=>s+g.tasks.length,0);
                html += `<div class="section-label">üì¶ BACKLOG <span class="section-count">${backlogTotal}</span>
                    <button class="collapse-toggle" onclick="toggleSection('backlogContent')">‚ñº</button></div>`;
                html += '<div id="backlogContent" class="collapsed">';
                for (const group of data.backlog) {
                    html += `<div class="backlog-list-name">${esc(group.name)}</div>`;
                    html += group.tasks.map(t =>
                        `<div class="wait-item" ${t.id?`data-task-id="${esc(t.id)}"`:''}">
                            <button class="card-check" onclick="completeTask(this)" title="Complete"></button>
                            <span>${esc(t.title)}</span>
                        </div>`
                    ).join('');
                }
                html += '</div>';
            }

            if (!html) html = '<div style="text-align:center;padding:3rem;color:var(--muted)">‚ú® Nothing to do. Nice.</div>';
            document.getElementById('content').innerHTML = html;
        }

        function toggleSection(id) {
            const el = document.getElementById(id);
            if (el) el.classList.toggle('collapsed');
        }

        async function completeTask(btn) {
            const card = btn.closest('.focus-card, .week-card, .wait-item');
            const taskId = card?.dataset?.taskId;
            if (!taskId) { showToast('No task ID', true); return; }
            if (btn.classList.contains('completing')) return;

            btn.classList.add('completing');
            card.classList.add('completed');

            try {
                const r = await fetch(`/api/tasks/complete?id=${encodeURIComponent(taskId)}`,{method:'POST'});
                const text = await r.text();
                let data; try{data=JSON.parse(text)}catch{data={error:text}}

                if (!r.ok || data.error) {
                    btn.classList.remove('completing'); card.classList.remove('completed');
                    btn.classList.add('error'); setTimeout(()=>btn.classList.remove('error'),600);
                    showToast(`Failed: ${data.error||r.status}`, true);
                    return;
                }

                showToast(`‚úì ${data.title||'Task'} done`, false);
                setTimeout(()=>{
                    card.classList.add('removing');
                    setTimeout(()=>card.remove(), 700);
                }, 400);
            } catch(e) {
                btn.classList.remove('completing'); card.classList.remove('completed');
                showToast(`Error: ${e.message}`, true);
            }
        }

        async function init() {
            const status = document.getElementById('statusText');
            try {
                status.textContent = 'Loading smart view...';
                const r = await fetch('/api/tasks/smart');
                if (!r.ok) throw new Error(`HTTP ${r.status}`);
                const data = await r.json();
                if (data.error) throw new Error(data.error);
                renderData(data);
                status.textContent = data.from_cache
                    ? `Cached (${Math.floor(data.cache_age/60)}m old) ¬∑ Tap üß† to re-analyze`
                    : 'Fresh AI analysis';
            } catch(e) {
                document.getElementById('content').innerHTML =
                    `<div style="text-align:center;padding:2rem;color:var(--accent)">‚ö†Ô∏è ${esc(e.message)}<br><small>Retrying in 10s...</small></div>`;
                setTimeout(init, 10000);
            }
        }

        async function fullRefresh() {
            const fab = document.getElementById('fabRefresh');
            const status = document.getElementById('statusText');
            if (fab.classList.contains('syncing')) return;
            fab.classList.add('syncing');
            status.textContent = 'Syncing + re-analyzing...';
            try {
                await fetch('/api/tasks/refresh');
                const r = await fetch('/api/tasks/smart?force');
                const data = await r.json();
                if (data.error) throw new Error(data.error);
                renderData(data);
                status.textContent = 'Fresh analysis ¬∑ just now';
                showToast('Re-analyzed ‚úì', false);
            } catch(e) {
                showToast(`Failed: ${e.message}`, true);
            } finally { fab.classList.remove('syncing'); }
        }

        async function syncOnly() {
            const fab = document.getElementById('fabSync');
            const status = document.getElementById('statusText');
            if (fab.classList.contains('syncing')) return;
            fab.classList.add('syncing');
            status.textContent = 'Syncing MS To Do...';
            try {
                await fetch('/api/tasks/refresh');
                const r = await fetch('/api/tasks/smart');
                const data = await r.json();
                renderData(data);
                status.textContent = 'Synced ¬∑ using cached analysis';
                showToast('Synced ‚úì', false);
            } catch(e) { showToast(`Failed: ${e.message}`, true); }
            finally { fab.classList.remove('syncing'); }
        }

        init();
    </script>
</body>
</html>

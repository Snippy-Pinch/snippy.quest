<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Today ‚Äî Schedule View | Snippy</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg: #0a0a1a; --surface: #111127; --surface2: #1a1a35;
            --border: #2a2a4a; --primary: #00d4aa; --accent: #ff6b6b;
            --warn: #f59e0b; --purple: #a78bfa; --blue: #60a5fa;
            --text: #e4e4e7; --muted: #7a8a9a;
            --work: #3b82f6; --personal: #8b5cf6; --free: #10b981;
            --lunch: #f59e0b;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg); color: var(--text);
            min-height: 100vh; line-height: 1.5;
        }
        .container { max-width: 760px; margin: 0 auto; padding: 24px 16px 100px; }

        .back-link {
            display: inline-flex; align-items: center; gap: 6px;
            color: var(--muted); text-decoration: none; font-size: 0.85rem;
            margin-bottom: 1rem; transition: color 0.2s;
        }
        .back-link:hover { color: var(--primary); }

        /* Header */
        .header { margin-bottom: 1.5rem; }
        .header h1 { font-size: 1.6rem; font-weight: 700; margin-bottom: 2px; }
        .header .date-str { color: var(--muted); font-size: 0.95rem; }
        .header .work-badge {
            display: inline-block; margin-top: 6px; font-size: 0.78rem;
            padding: 3px 10px; border-radius: 20px;
            background: rgba(59,130,246,0.12); color: var(--work);
            border: 1px solid rgba(59,130,246,0.25);
        }
        .header .off-badge {
            background: rgba(16,185,129,0.12); color: var(--free);
            border: 1px solid rgba(16,185,129,0.25);
        }

        /* All-day banner */
        .all-day-bar {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 10px; padding: 10px 14px; margin-bottom: 1rem;
            display: flex; gap: 8px; align-items: center; flex-wrap: wrap;
        }
        .all-day-tag {
            font-size: 0.78rem; padding: 3px 10px; border-radius: 6px;
            background: rgba(167,139,250,0.1); color: var(--purple);
            border: 1px solid rgba(167,139,250,0.2);
        }
        .all-day-label { font-size: 0.75rem; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; }

        /* Stats row */
        .stats-row { display: flex; gap: 8px; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .stat {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 10px; padding: 10px 14px; text-align: center; flex: 1; min-width: 80px;
        }
        .stat .num { font-size: 1.2rem; font-weight: 700; }
        .stat .label { font-size: 0.65rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }

        /* Timeline */
        .timeline-section { margin-top: 1rem; }
        .section-label {
            font-size: 0.72rem; text-transform: uppercase; letter-spacing: 1.5px;
            color: var(--muted); margin-bottom: 0.75rem; padding-bottom: 6px;
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; gap: 8px;
        }

        .timeline {
            position: relative;
            padding-left: 60px;
        }

        /* Time gutter */
        .time-slot {
            position: relative;
            min-height: 48px;
            margin-bottom: 2px;
        }
        .time-label {
            position: absolute;
            left: -58px;
            top: 0;
            width: 48px;
            font-size: 0.72rem;
            color: var(--muted);
            text-align: right;
            font-variant-numeric: tabular-nums;
            padding-top: 2px;
        }

        /* Event blocks */
        .event-block {
            border-radius: 8px;
            padding: 8px 12px;
            margin-bottom: 3px;
            font-size: 0.85rem;
            position: relative;
            border-left: 3px solid;
            transition: all 0.2s;
        }
        .event-block:hover { filter: brightness(1.15); }

        .event-block.work {
            background: rgba(59,130,246,0.08);
            border-left-color: var(--work);
        }
        .event-block.work-free {
            background: rgba(59,130,246,0.04);
            border-left-color: var(--work);
            opacity: 0.6;
            border-left-style: dashed;
        }
        .event-block.personal {
            background: rgba(139,92,246,0.1);
            border-left-color: var(--personal);
        }
        .event-block.lunch {
            background: rgba(245,158,11,0.08);
            border-left-color: var(--lunch);
        }
        .event-block.free-window {
            background: rgba(16,185,129,0.06);
            border-left-color: var(--free);
            border-left-style: dashed;
        }

        .event-title {
            font-weight: 600; font-size: 0.88rem;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .event-time {
            font-size: 0.72rem; color: var(--muted); margin-top: 1px;
        }
        .event-meta {
            font-size: 0.7rem; color: var(--muted); margin-top: 2px;
        }

        /* Current time indicator */
        .now-line {
            position: absolute;
            left: 0; right: 0;
            height: 2px;
            background: var(--accent);
            z-index: 10;
            pointer-events: none;
        }
        .now-line::before {
            content: 'NOW';
            position: absolute;
            left: -54px;
            top: -8px;
            font-size: 0.65rem;
            font-weight: 700;
            color: var(--accent);
            letter-spacing: 1px;
        }
        .now-dot {
            position: absolute;
            left: -5px; top: -4px;
            width: 10px; height: 10px;
            background: var(--accent);
            border-radius: 50%;
        }

        /* Up next card */
        .up-next {
            background: linear-gradient(135deg, rgba(0,212,170,0.08), rgba(139,92,246,0.08));
            border: 1px solid rgba(0,212,170,0.2);
            border-radius: 12px; padding: 14px 16px;
            margin-bottom: 1.5rem;
        }
        .up-next-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; color: var(--primary); margin-bottom: 6px; }
        .up-next-title { font-weight: 700; font-size: 1.05rem; }
        .up-next-time { font-size: 0.85rem; color: var(--muted); }
        .up-next-countdown { font-size: 0.85rem; color: var(--warn); margin-top: 4px; }

        /* Free windows summary */
        .free-summary {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 10px; padding: 14px 16px; margin-bottom: 1.5rem;
        }
        .free-summary h3 {
            font-size: 0.85rem; color: var(--free); margin-bottom: 8px;
        }
        .free-chip {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 5px 12px; border-radius: 20px; margin: 3px 4px 3px 0;
            font-size: 0.82rem; background: rgba(16,185,129,0.08);
            border: 1px solid rgba(16,185,129,0.2); color: var(--free);
        }

        /* Date nav */
        .date-nav {
            display: flex; align-items: center; gap: 12px;
            margin-bottom: 0.5rem;
        }
        .date-nav button {
            background: var(--surface); border: 1px solid var(--border);
            color: var(--text); border-radius: 8px; padding: 6px 14px;
            font-size: 0.82rem; cursor: pointer; transition: all 0.2s;
        }
        .date-nav button:hover { border-color: var(--primary); color: var(--primary); }
        .date-nav button:active { transform: scale(0.95); }
        .date-nav .today-btn { color: var(--primary); border-color: rgba(0,212,170,0.3); }

        /* Loading */
        .loading { text-align: center; padding: 3rem 0; color: var(--muted); }
        .spinner {
            width: 32px; height: 32px; border: 3px solid var(--border);
            border-top-color: var(--primary); border-radius: 50%;
            animation: spin 0.7s linear infinite; margin: 0 auto 0.75rem;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 480px) {
            .container { padding: 20px 12px 80px; }
            .header h1 { font-size: 1.4rem; }
            .timeline { padding-left: 50px; }
            .time-label { left: -48px; width: 40px; font-size: 0.68rem; }
            .event-title { font-size: 0.82rem; }
            .stats-row { gap: 6px; }
            .stat { padding: 8px 10px; }
            .stat .num { font-size: 1rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/private/today/" class="back-link">‚Üê Today Dashboard</a>

        <div class="header">
            <h1 id="title">üìÖ Loading schedule...</h1>
            <div class="date-str" id="dateStr"></div>
        </div>

        <div class="date-nav">
            <button onclick="navDay(-1)">‚Üê Prev</button>
            <button class="today-btn" onclick="navToday()">Today</button>
            <button onclick="navDay(1)">Next ‚Üí</button>
        </div>

        <div id="content">
            <div class="loading">
                <div class="spinner"></div>
                <p>Fetching calendar...</p>
            </div>
        </div>
    </div>

    <script>
        let currentDate = new Date().toISOString().slice(0, 10);
        const API = '/api/schedule';

        function esc(s) { if(!s) return ''; const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }

        function fmtTime12(t) {
            if (!t) return '';
            const [h, m] = t.split(':').map(Number);
            const ampm = h >= 12 ? 'PM' : 'AM';
            const h12 = h % 12 || 12;
            return m === 0 ? `${h12} ${ampm}` : `${h12}:${String(m).padStart(2,'0')} ${ampm}`;
        }

        function minutesBetween(a, b) {
            const [ah, am] = a.split(':').map(Number);
            const [bh, bm] = b.split(':').map(Number);
            return (bh * 60 + bm) - (ah * 60 + am);
        }

        function formatDuration(mins) {
            if (mins < 60) return `${mins}m`;
            const h = Math.floor(mins / 60), m = mins % 60;
            return m ? `${h}h ${m}m` : `${h}h`;
        }

        function classifyEvent(ev, isWork) {
            if (!isWork) return 'personal';
            const subj = ev.subject.toLowerCase();
            if (subj.includes('lunch')) return 'lunch';
            if (ev.showAs === 'free') return 'work-free';
            return 'work';
        }

        function findUpNext(allEvents, currentTime) {
            if (!currentTime) return null;
            const now = currentTime.replace(':', '');
            for (const ev of allEvents) {
                const start = ev.start.replace(':', '');
                if (start > now) return ev;
            }
            return null;
        }

        function render(data) {
            const isToday = data.date === new Date().toISOString().slice(0, 10);
            const dateObj = new Date(data.date + 'T12:00:00');
            const dateStr = dateObj.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            document.getElementById('title').textContent = `üìÖ ${data.day}'s Schedule`;
            document.getElementById('dateStr').innerHTML = dateStr +
                (data.work_hours
                    ? ` <span class="work-badge">üíº ${fmtTime12(data.work_hours.start)} ‚Äì ${fmtTime12(data.work_hours.end)}</span>`
                    : ` <span class="work-badge off-badge">üå§ Day Off</span>`);

            let html = '';

            // All-day events
            if (data.all_day && data.all_day.length > 0) {
                html += '<div class="all-day-bar"><span class="all-day-label">All Day</span>';
                for (const e of data.all_day) {
                    html += `<span class="all-day-tag">${esc(e.subject)}</span>`;
                }
                html += '</div>';
            }

            // Merge and sort all timed events
            const allEvents = [];
            for (const e of (data.work_events || [])) {
                allEvents.push({...e, _type: classifyEvent(e, true), _src: 'work'});
            }
            for (const e of (data.personal_events || [])) {
                allEvents.push({...e, _type: 'personal', _src: 'personal'});
            }
            allEvents.sort((a, b) => a.start.localeCompare(b.start));

            // Stats
            const workMins = (data.work_events || []).reduce((s, e) => s + Math.max(0, minutesBetween(e.start, e.end)), 0);
            const personalMins = (data.personal_events || []).reduce((s, e) => s + Math.max(0, minutesBetween(e.start, e.end)), 0);
            const freeMins = (data.free_windows || []).reduce((s, w) => s + Math.max(0, minutesBetween(w.start, w.end)), 0);

            html += '<div class="stats-row">';
            html += `<div class="stat"><div class="num" style="color:var(--work)">${allEvents.filter(e=>e._src==='work').length}</div><div class="label">Work</div></div>`;
            html += `<div class="stat"><div class="num" style="color:var(--personal)">${allEvents.filter(e=>e._src==='personal').length}</div><div class="label">Personal</div></div>`;
            html += `<div class="stat"><div class="num" style="color:var(--free)">${formatDuration(freeMins)}</div><div class="label">Free Time</div></div>`;
            html += `<div class="stat"><div class="num" style="color:var(--text)">${allEvents.length}</div><div class="label">Total</div></div>`;
            html += '</div>';

            // Up next (only for today)
            if (isToday && data.current_time) {
                const upNext = findUpNext(allEvents, data.current_time);
                if (upNext) {
                    const minsUntil = minutesBetween(data.current_time, upNext.start);
                    html += `<div class="up-next">
                        <div class="up-next-label">‚è≠ Up Next</div>
                        <div class="up-next-title">${esc(upNext.subject)}</div>
                        <div class="up-next-time">${fmtTime12(upNext.start)} ‚Äì ${fmtTime12(upNext.end)}</div>
                        ${minsUntil > 0 ? `<div class="up-next-countdown">in ${formatDuration(minsUntil)}</div>` : ''}
                    </div>`;
                }
            }

            // Free windows
            if (data.free_windows && data.free_windows.length > 0) {
                html += '<div class="free-summary"><h3>üü¢ Free Windows</h3>';
                for (const w of data.free_windows) {
                    const dur = minutesBetween(w.start, w.end);
                    html += `<span class="free-chip">${fmtTime12(w.start)} ‚Äì ${fmtTime12(w.end)} (${formatDuration(dur)})</span>`;
                }
                html += '</div>';
            }

            // Timeline
            html += '<div class="section-label">üìã Timeline</div>';
            html += '<div class="timeline" id="timeline">';

            // Determine time range
            let earliest = '07:00', latest = '22:00';
            if (allEvents.length) {
                earliest = allEvents[0].start;
                latest = allEvents[allEvents.length - 1].end;
            }
            // Round to hour boundaries
            let startHour = Math.max(6, parseInt(earliest.split(':')[0]));
            let endHour = Math.min(23, parseInt(latest.split(':')[0]) + 1);

            // Build hour-by-hour slots with events
            let lastRenderedEnd = null;
            for (const ev of allEvents) {
                const hour = parseInt(ev.start.split(':')[0]);
                const min = parseInt(ev.start.split(':')[1]);
                const timeStr = fmtTime12(ev.start);
                const dur = minutesBetween(ev.start, ev.end);

                // Show time label if new time slot
                const showTime = !lastRenderedEnd || ev.start !== lastRenderedEnd;

                html += `<div class="time-slot">`;
                if (showTime) {
                    html += `<div class="time-label">${timeStr}</div>`;
                }
                html += `<div class="event-block ${ev._type}">
                    <div class="event-title">${esc(ev.subject)}</div>
                    <div class="event-time">${fmtTime12(ev.start)} ‚Äì ${fmtTime12(ev.end)}${dur > 0 ? ` ¬∑ ${formatDuration(dur)}` : ''}</div>
                    ${ev.calendar ? `<div class="event-meta">${esc(ev.calendar)}</div>` : ''}
                </div>`;
                html += `</div>`;

                lastRenderedEnd = ev.end;
            }

            // Current time marker (for today)
            if (isToday && data.current_time) {
                html += `<div class="now-marker" data-time="${data.current_time}"></div>`;
            }

            html += '</div>'; // .timeline

            if (allEvents.length === 0) {
                html += '<div style="text-align:center;padding:2rem;color:var(--muted)">No events scheduled. Enjoy the freedom. üå§</div>';
            }

            document.getElementById('content').innerHTML = html;

            // Position NOW marker
            if (isToday && data.current_time) {
                positionNowMarker(data.current_time, allEvents);
            }
        }

        function positionNowMarker(currentTime, allEvents) {
            const timeline = document.getElementById('timeline');
            if (!timeline) return;

            const slots = timeline.querySelectorAll('.time-slot');
            if (!slots.length) return;

            // Find the slot closest to current time
            const nowMins = parseInt(currentTime.split(':')[0]) * 60 + parseInt(currentTime.split(':')[1]);
            let insertAfter = null;

            for (const slot of slots) {
                const block = slot.querySelector('.event-block');
                if (!block) continue;
                const timeText = block.querySelector('.event-time')?.textContent || '';
                // Extract start time from event
                const evStart = block.closest('.time-slot')?.querySelector('.time-label')?.textContent;
            }

            // Simple: add the now line after the timeline label
            const nowLine = document.createElement('div');
            nowLine.className = 'now-line';
            nowLine.innerHTML = '<div class="now-dot"></div>';
            nowLine.style.position = 'relative';
            nowLine.style.margin = '12px 0';

            // Find where to insert ‚Äî after events that have started
            let lastPastSlot = null;
            for (const slot of slots) {
                const timeLabel = slot.querySelector('.time-label');
                if (timeLabel) {
                    // Parse the 12h time
                    const text = timeLabel.textContent.trim();
                    const match = text.match(/(\d+):?(\d*)\s*(AM|PM)/i);
                    if (match) {
                        let h = parseInt(match[1]);
                        const m = match[2] ? parseInt(match[2]) : 0;
                        const ampm = match[3].toUpperCase();
                        if (ampm === 'PM' && h !== 12) h += 12;
                        if (ampm === 'AM' && h === 12) h = 0;
                        const slotMins = h * 60 + m;
                        if (slotMins <= nowMins) lastPastSlot = slot;
                    }
                }
            }

            if (lastPastSlot && lastPastSlot.nextSibling) {
                timeline.insertBefore(nowLine, lastPastSlot.nextSibling);
            } else if (lastPastSlot) {
                timeline.appendChild(nowLine);
            }
        }

        async function loadSchedule(dateStr) {
            document.getElementById('content').innerHTML = '<div class="loading"><div class="spinner"></div><p>Fetching calendar...</p></div>';
            try {
                const url = dateStr ? `${API}?date=${dateStr}` : API;
                const r = await fetch(url);
                if (!r.ok) throw new Error(`HTTP ${r.status}`);
                const data = await r.json();
                if (data.error) throw new Error(data.error);
                render(data);
            } catch (e) {
                document.getElementById('content').innerHTML =
                    `<div style="text-align:center;padding:2rem;color:var(--accent)">‚ö†Ô∏è ${esc(e.message)}</div>`;
            }
        }

        function navDay(offset) {
            const d = new Date(currentDate + 'T12:00:00');
            d.setDate(d.getDate() + offset);
            currentDate = d.toISOString().slice(0, 10);
            loadSchedule(currentDate);
        }

        function navToday() {
            currentDate = new Date().toISOString().slice(0, 10);
            loadSchedule(currentDate);
        }

        // Auto-refresh every 60s for today
        loadSchedule();
        setInterval(() => {
            if (currentDate === new Date().toISOString().slice(0, 10)) {
                loadSchedule(currentDate);
            }
        }, 60000);
    </script>
</body>
</html>
